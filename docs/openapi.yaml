openapi: 3.1.0
info:
  title: DDNS MVP API Contract
  version: 0.1.0
  description: |
    API contract for gateway, tollbooth, and miner-witness services.
    This file documents currently available MVP endpoints for resolve, health, status, and inventory-style views.
servers:
  - url: http://localhost:8054
    description: gateway
  - url: http://localhost:8788
    description: tollbooth
  - url: http://localhost:8790
    description: miner-witness
paths:
  /v1/resolve:
    get:
      summary: Resolve a name
      parameters:
        - in: query
          name: name
          required: true
          schema: { type: string }
        - in: query
          name: type
          required: false
          schema:
            type: string
            enum: [A, AAAA]
      responses:
        '200':
          description: Resolved answer
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ResolveResponse'
  /healthz:
    get:
      summary: Gateway health
      responses:
        '200':
          description: ok
          content:
            application/json:
              schema:
                type: object
                properties:
                  status: { type: string }
  /v1/attack-mode:
    get:
      summary: Gateway status (attack mode policy)
      responses:
        '200':
          description: Current policy mode and counters
          content:
            application/json:
              schema:
                type: object
  /registry/root:
    get:
      summary: Registry inventory snapshot root
      responses:
        '200':
          description: Registry root and metadata
          content:
            application/json:
              schema:
                type: object
  /v1/challenge:
    get:
      summary: Tollbooth wallet challenge
      parameters:
        - in: query
          name: wallet
          required: true
          schema: { type: string }
      responses:
        '200':
          description: Nonce challenge
          content:
            application/json:
              schema:
                type: object
  /v1/claim-passport:
    post:
      summary: Claim toll passport
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        '200':
          description: Passport claim result
          content:
            application/json:
              schema:
                type: object
  /v1/assign-route:
    post:
      summary: Assign .dns route
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        '200':
          description: Route assignment result
          content:
            application/json:
              schema:
                type: object
  /v1/health:
    get:
      summary: Miner-witness health
      responses:
        '200':
          description: Service mode and window status
          content:
            application/json:
              schema:
                type: object
  /v1/submit-receipts:
    post:
      summary: Submit witness receipts
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        '200':
          description: Receipt acceptance summary
          content:
            application/json:
              schema:
                type: object
  /v1/registrar/domain:
    get:
      summary: Mock registrar domain status
      x-feature-flag: REGISTRAR_ENABLED
      x-provider: REGISTRAR_PROVIDER
      parameters:
        - in: query
          name: domain
          required: true
          schema: { type: string }
      responses:
        '200':
          description: Registrar domain record
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RegistrarDomainRecord'
  /v1/registrar/quote:
    get:
      summary: Renewal quote from registrar adapter
      x-feature-flag: REGISTRAR_ENABLED
      x-provider: REGISTRAR_PROVIDER
      parameters:
        - in: query
          name: domain
          required: true
          schema: { type: string }
      responses:
        '200':
          description: Renewal quote
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RegistrarRenewalQuoteResponse'
  /v1/registrar/renew:
    post:
      summary: Request renewal through registrar adapter
      x-feature-flag: REGISTRAR_ENABLED
      x-provider: REGISTRAR_PROVIDER
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegistrarRenewRequest'
      responses:
        '200':
          description: Renewal submission result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RegistrarRenewResponse'
  /v1/registrar/ns:
    post:
      summary: Update domain nameservers via registrar adapter
      x-feature-flag: REGISTRAR_ENABLED
      x-provider: REGISTRAR_PROVIDER
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegistrarNsUpdateRequest'
      responses:
        '200':
          description: Nameserver update result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RegistrarNsUpdateResponse'
  /v1/domain/status:
    get:
      summary: Domain continuity status
      parameters:
        - in: query
          name: domain
          required: true
          schema: { type: string }
      responses:
        '200':
          description: Domain continuity status snapshot
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DomainContinuityStatusResponse'
  /v1/domain/verify:
    post:
      summary: Start domain control verification for continuity
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DomainVerifyRequest'
      responses:
        '200':
          description: Verification challenge details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DomainVerifyResponse'
  /v1/domain/renew:
    post:
      summary: Request domain renewal (payment abstraction; optional credit usage)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DomainRenewRequest'
      responses:
        '200':
          description: Renewal request result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DomainRenewResponse'
  /v1/domain/continuity:
    get:
      summary: Combined continuity view with registrar status and subsidy eligibility
      parameters:
        - in: query
          name: domain
          required: true
          schema: { type: string }
      responses:
        '200':
          description: Continuity state + registrar summary
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DomainContinuityCombinedResponse'
  /v1/domain/continuity/claim:
    post:
      summary: Claim continuity protection enrollment
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DomainContinuityClaimRequest'
      responses:
        '200':
          description: Continuity claim result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DomainContinuityClaimResponse'
  /v1/domain/notice:
    get:
      summary: Issue a signed continuity notice token
      parameters:
        - in: query
          name: domain
          required: true
          schema: { type: string }
      responses:
        '200':
          description: Signed notice token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DomainNoticeTokenResponse'
  /v1/domain/notice/verify:
    post:
      summary: Verify signed continuity notice token
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DomainNoticeVerifyRequest'
      responses:
        '200':
          description: Notice verification result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DomainNoticeVerifyResponse'
  /v1/domain/banner:
    get:
      summary: Render continuity banner/interstitial HTML for a domain
      parameters:
        - in: query
          name: domain
          required: true
          schema: { type: string }
        - in: query
          name: mode
          required: false
          schema:
            type: string
            enum: [banner, interstitial]
      responses:
        '200':
          description: Rendered HTML with injected continuity notice token
          content:
            text/html:
              schema:
                type: string
components:
  schemas:
    ResolveAnswer:
      type: object
      properties:
        name: { type: string }
        type: { type: string }
        data: { type: string }
        ttl: { type: integer }
    ResolveResponse:
      type: object
      properties:
        name: { type: string }
        type: { type: string }
        answers:
          type: array
          items:
            $ref: '#/components/schemas/ResolveAnswer'
        ttl_s: { type: integer }
        source: { type: string }
        confidence:
          type: string
          enum: [high, medium, low]
        rrset_hash: { type: string }
    RegistrarDomainStatus:
      type: string
      enum: [active, expiring, expired, redemption, pending_transfer, unknown]
    RegistrarDomainRecord:
      type: object
      properties:
        domain: { type: string }
        status:
          $ref: '#/components/schemas/RegistrarDomainStatus'
        renewal_due_date:
          type: string
          format: date-time
          nullable: true
        grace_expires_at:
          type: string
          format: date-time
          nullable: true
        ns:
          type: array
          items: { type: string }
        traffic_signal:
          type: string
          enum: [none, low, real]
        credits_balance: { type: number }
        registrar_enabled: { type: boolean }
        provider: { type: string }
        dry_run: { type: boolean }
    RegistrarRenewalQuoteResponse:
      type: object
      properties:
        domain: { type: string }
        price_usd: { type: number }
        price_sol: { type: number }
        supported: { type: boolean }
        expires_at:
          type: string
          format: date-time
        registrar_enabled: { type: boolean }
        provider: { type: string }
        dry_run: { type: boolean }
    RegistrarRenewRequest:
      type: object
      required: [domain, years]
      properties:
        domain: { type: string }
        years: { type: integer, minimum: 1 }
    RegistrarRenewResponse:
      type: object
      properties:
        domain: { type: string }
        years: { type: integer }
        status:
          type: string
          enum: [submitted, failed, insufficient_credits]
        submitted: { type: boolean }
        provider_ref: { type: string }
        errors:
          type: array
          items: { type: string }
        required_usd: { type: number }
        covered_usd: { type: number }
        remaining_usd: { type: number }
        instruction: { type: string, nullable: true }
        registrar_enabled: { type: boolean }
        provider: { type: string }
        dry_run: { type: boolean }
    RegistrarNsUpdateRequest:
      type: object
      required: [domain, ns]
      properties:
        domain: { type: string }
        ns:
          type: array
          minItems: 2
          items: { type: string }
    RegistrarNsUpdateResponse:
      type: object
      properties:
        domain: { type: string }
        ns:
          type: array
          items: { type: string }
        ok: { type: boolean }
        provider_ref: { type: string }
        errors:
          type: array
          items: { type: string }
        registrar_enabled: { type: boolean }
        provider: { type: string }
        dry_run: { type: boolean }
    DomainContinuityPhase:
      type: string
      enum: [A_SOFT_WARNING, B_HARD_WARNING, C_SAFE_PARKED, D_REGISTRY_FINALIZATION]
    DomainContinuityStatusResponse:
      type: object
      properties:
        domain: { type: string }
        eligible: { type: boolean }
        phase:
          $ref: '#/components/schemas/DomainContinuityPhase'
        reason_codes:
          type: array
          items: { type: string }
        next_steps:
          type: array
          items: { type: string }
        credits_balance: { type: number }
        credits_applied_estimate: { type: number }
        uses_ddns_ns: { type: boolean }
        eligible_for_hold: { type: boolean }
        eligible_for_subsidy: { type: boolean }
        renewal_due_date:
          type: string
          format: date-time
        grace_expires_at:
          type: string
          format: date-time
        policy_version: { type: string }
        auth_required: { type: boolean }
        auth_mode: { type: string, enum: [stub] }
        owner_pubkey: { type: string, nullable: true }
        txt_record_name: { type: string, nullable: true }
        txt_record_value: { type: string, nullable: true }
        notice_signature: { type: string }
    DomainVerifyRequest:
      type: object
      required: [domain]
      properties:
        domain: { type: string }
    DomainVerifyResponse:
      type: object
      properties:
        domain: { type: string }
        verification_method:
          type: string
          enum: [dns_txt, account_token, signer_proof]
        txt_record_name: { type: string }
        txt_record_value: { type: string }
        verification_token: { type: string }
        expires_at:
          type: string
          format: date-time
        auth_required: { type: boolean }
        auth_mode: { type: string, enum: [stub] }
        policy_version: { type: string }
    DomainRenewRequest:
      type: object
      required: [domain]
      properties:
        domain: { type: string }
        years: { type: integer, minimum: 1, default: 1 }
        use_credits: { type: boolean, default: true }
    DomainRenewResponse:
      type: object
      properties:
        domain: { type: string }
        accepted: { type: boolean }
        message: { type: string }
        reason_codes:
          type: array
          items: { type: string }
        credits_applied_estimate: { type: number }
        renewal_due_date:
          type: string
          format: date-time
        grace_expires_at:
          type: string
          format: date-time
        auth_required: { type: boolean }
        auth_mode: { type: string, enum: [stub] }
        policy_version: { type: string }
        notice_signature: { type: string }
    DomainContinuityClaimRequest:
      type: object
      required: [domain]
      properties:
        domain: { type: string }
    DomainContinuityClaimResponse:
      type: object
      properties:
        domain: { type: string }
        accepted: { type: boolean }
        eligible: { type: boolean }
        phase:
          $ref: '#/components/schemas/DomainContinuityPhase'
        reason_codes:
          type: array
          items: { type: string }
        next_steps:
          type: array
          items: { type: string }
        auth_required: { type: boolean }
        auth_mode: { type: string, enum: [stub] }
        policy_version: { type: string }
        notice_signature: { type: string }
    DomainContinuityCombinedResponse:
      allOf:
        - $ref: '#/components/schemas/DomainContinuityStatusResponse'
        - type: object
          properties:
            registrar_status:
              $ref: '#/components/schemas/RegistrarDomainStatus'
    DomainNoticeTokenResponse:
      type: object
      properties:
        domain: { type: string }
        phase:
          $ref: '#/components/schemas/DomainContinuityPhase'
        token: { type: string }
        pubkey: { type: string }
    DomainNoticeVerifyRequest:
      type: object
      required: [token]
      properties:
        token: { type: string }
    DomainNoticeVerifyResponse:
      type: object
      properties:
        valid: { type: boolean }
        payload:
          type: object
          properties:
            domain: { type: string }
            phase:
              $ref: '#/components/schemas/DomainContinuityPhase'
            issued_at:
              type: string
              format: date-time
            expires_at:
              type: string
              format: date-time
            reason_codes:
              type: array
              items: { type: string }
            policy_version: { type: string }
            nonce: { type: string }
