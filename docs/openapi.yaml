openapi: 3.1.0
info:
  title: DDNS MVP API Contract
  version: 0.1.0
  description: |
    API contract for gateway, tollbooth, and miner-witness services.
    This file documents currently available MVP endpoints for resolve, health, status, and inventory-style views.
servers:
  - url: http://localhost:8054
    description: gateway
  - url: http://localhost:8788
    description: tollbooth
  - url: http://localhost:8790
    description: miner-witness
paths:
  /v1/resolve:
    get:
      summary: Resolve a name
      parameters:
        - in: query
          name: name
          required: true
          schema: { type: string }
        - in: query
          name: type
          required: false
          schema:
            type: string
            enum: [A, AAAA]
      responses:
        '200':
          description: Resolved answer
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ResolveResponse'
  /healthz:
    get:
      summary: Gateway health
      responses:
        '200':
          description: ok
          content:
            application/json:
              schema:
                type: object
                properties:
                  status: { type: string }
  /v1/attack-mode:
    get:
      summary: Gateway status (attack mode policy)
      responses:
        '200':
          description: Current policy mode and counters
          content:
            application/json:
              schema:
                type: object
  /registry/root:
    get:
      summary: Registry inventory snapshot root
      responses:
        '200':
          description: Registry root and metadata
          content:
            application/json:
              schema:
                type: object
  /v1/challenge:
    get:
      summary: Tollbooth wallet challenge
      parameters:
        - in: query
          name: wallet
          required: true
          schema: { type: string }
      responses:
        '200':
          description: Nonce challenge
          content:
            application/json:
              schema:
                type: object
  /v1/claim-passport:
    post:
      summary: Claim toll passport
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        '200':
          description: Passport claim result
          content:
            application/json:
              schema:
                type: object
  /v1/assign-route:
    post:
      summary: Assign .dns route
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        '200':
          description: Route assignment result
          content:
            application/json:
              schema:
                type: object
  /v1/health:
    get:
      summary: Miner-witness health
      responses:
        '200':
          description: Service mode and window status
          content:
            application/json:
              schema:
                type: object
  /v1/submit-receipts:
    post:
      summary: Submit witness receipts
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        '200':
          description: Receipt acceptance summary
          content:
            application/json:
              schema:
                type: object
  /v1/domain/status:
    get:
      summary: Domain continuity status
      parameters:
        - in: query
          name: domain
          required: true
          schema: { type: string }
      responses:
        '200':
          description: Domain continuity status snapshot
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DomainContinuityStatusResponse'
  /v1/domain/verify:
    post:
      summary: Start domain control verification for continuity
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DomainVerifyRequest'
      responses:
        '200':
          description: Verification challenge details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DomainVerifyResponse'
  /v1/domain/renew:
    post:
      summary: Request domain renewal (payment abstraction; optional credit usage)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DomainRenewRequest'
      responses:
        '200':
          description: Renewal request result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DomainRenewResponse'
  /v1/domain/continuity/claim:
    post:
      summary: Claim continuity protection enrollment
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DomainContinuityClaimRequest'
      responses:
        '200':
          description: Continuity claim result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DomainContinuityClaimResponse'
components:
  schemas:
    ResolveAnswer:
      type: object
      properties:
        name: { type: string }
        type: { type: string }
        data: { type: string }
        ttl: { type: integer }
    ResolveResponse:
      type: object
      properties:
        name: { type: string }
        type: { type: string }
        answers:
          type: array
          items:
            $ref: '#/components/schemas/ResolveAnswer'
        ttl_s: { type: integer }
        source: { type: string }
        confidence:
          type: string
          enum: [high, medium, low]
        rrset_hash: { type: string }
    DomainContinuityPhase:
      type: string
      enum: [A_SOFT_WARNING, B_HARD_WARNING, C_SAFE_PARKED, D_REGISTRY_FINALIZATION]
    DomainContinuityStatusResponse:
      type: object
      properties:
        domain: { type: string }
        eligible: { type: boolean }
        phase:
          $ref: '#/components/schemas/DomainContinuityPhase'
        reason_codes:
          type: array
          items: { type: string }
        next_steps:
          type: array
          items: { type: string }
        credits_balance: { type: number }
        credits_applied_estimate: { type: number }
        renewal_due_date:
          type: string
          format: date-time
        grace_expires_at:
          type: string
          format: date-time
        policy_version: { type: string }
        notice_signature: { type: string }
    DomainVerifyRequest:
      type: object
      required: [domain]
      properties:
        domain: { type: string }
    DomainVerifyResponse:
      type: object
      properties:
        domain: { type: string }
        verification_method:
          type: string
          enum: [dns_txt, account_token, signer_proof]
        txt_record_name: { type: string }
        txt_record_value: { type: string }
        verification_token: { type: string }
        expires_at:
          type: string
          format: date-time
        policy_version: { type: string }
    DomainRenewRequest:
      type: object
      required: [domain]
      properties:
        domain: { type: string }
        use_credits: { type: boolean, default: true }
    DomainRenewResponse:
      type: object
      properties:
        domain: { type: string }
        accepted: { type: boolean }
        reason_codes:
          type: array
          items: { type: string }
        credits_applied_estimate: { type: number }
        renewal_due_date:
          type: string
          format: date-time
        grace_expires_at:
          type: string
          format: date-time
        policy_version: { type: string }
        notice_signature: { type: string }
    DomainContinuityClaimRequest:
      type: object
      required: [domain]
      properties:
        domain: { type: string }
    DomainContinuityClaimResponse:
      type: object
      properties:
        domain: { type: string }
        accepted: { type: boolean }
        eligible: { type: boolean }
        phase:
          $ref: '#/components/schemas/DomainContinuityPhase'
        reason_codes:
          type: array
          items: { type: string }
        next_steps:
          type: array
          items: { type: string }
        policy_version: { type: string }
        notice_signature: { type: string }
