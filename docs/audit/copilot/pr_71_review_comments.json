[{"url":"https://api.github.com/repos/cwalinapj/DECENTRALIZED-DNS-/pulls/comments/2824363461","pull_request_review_id":3822130660,"id":2824363461,"node_id":"PRRC_kwDORKbd9s6oWF3F","diff_hunk":"@@ -0,0 +1,282 @@\n+import fs from \"node:fs\";\n+import path from \"node:path\";\n+import crypto from \"node:crypto\";\n+import yargs from \"yargs\";\n+import { hideBin } from \"yargs/helpers\";\n+import * as anchor from \"@coral-xyz/anchor\";\n+import { Connection, Keypair, PublicKey, SystemProgram } from \"@solana/web3.js\";\n+import BN from \"bn.js\";\n+\n+const DEFAULT_RPC =\n+  process.env.SOLANA_RPC_URL || process.env.ANCHOR_PROVIDER_URL || \"https://api.devnet.solana.com\";\n+const DEFAULT_WALLET =\n+  process.env.WALLET || process.env.ANCHOR_WALLET || path.join(process.env.HOME || \".\", \".config/solana/id.json\");\n+\n+function loadKeypair(filePath: string): Keypair {\n+  const raw = JSON.parse(fs.readFileSync(filePath, \"utf8\"));\n+  return Keypair.fromSecretKey(Uint8Array.from(raw));\n+}\n+\n+function loadIdl() {\n+  const p = path.resolve(\"target/idl/ddns_names.json\");\n+  if (!fs.existsSync(p)) {\n+    throw new Error(`IDL not found at ${p}. Run: anchor build --program-name ddns_names`);\n+  }\n+  const idl = JSON.parse(fs.readFileSync(p, \"utf8\"));\n+  // Anchor TS can choke on account namespace for legacy/minimal IDLs. Methods still work without it.\n+  delete idl.accounts;\n+  return idl;\n+}\n+\n+function readProgramIdFromAnchorToml(rpcUrl: string, program = \"ddns_names\"): string | null {\n+  try {\n+    const tomlPath = path.resolve(\"Anchor.toml\");\n+    if (!fs.existsSync(tomlPath)) return null;\n+    const content = fs.readFileSync(tomlPath, \"utf8\");\n+    const isLocal = /127\\.0\\.0\\.1|localhost/.test(rpcUrl);\n+    const section = isLocal ? \"programs.localnet\" : \"programs.devnet\";\n+    const re = new RegExp(`\\\\[${section}\\\\][^\\\\[]*?${program}\\\\s*=\\\\s*\\\"([^\\\"]+)\\\"`, \"s\");\n+    const m = content.match(re);\n+    return m ? m[1] : null;\n+  } catch {\n+    return null;\n+  }\n+}\n+\n+function normalizeFullName(name: string): string {\n+  return name.trim().toLowerCase().replace(/\\.+$/, \"\");\n+}\n+\n+function normalizeLabel(label: string): string {\n+  return label.trim().toLowerCase();\n+}\n+\n+function sha256Bytes(data: Buffer | string): Buffer {\n+  return crypto.createHash(\"sha256\").update(data).digest();\n+}\n+\n+function hashName(name: string): Uint8Array {\n+  return Uint8Array.from(sha256Bytes(normalizeFullName(name)));\n+}\n+\n+function hashLabel(label: string): Uint8Array {\n+  return Uint8Array.from(sha256Bytes(normalizeLabel(label)));\n+}\n+\n+async function fetchTreasuryFromConfig(connection: Connection, configPda: PublicKey): Promise<PublicKey> {\n+  const info = await connection.getAccountInfo(configPda);\n+  if (!info || !info.data || info.data.length < 8 + 64) {\n+    throw new Error(`names config not found at ${configPda.toBase58()}`);\n+  }\n+  return new PublicKey(info.data.subarray(8 + 32, 8 + 64));\n+}\n+\n+async function fetchPrimaryRaw(connection: Connection, primaryPda: PublicKey) {\n+  const info = await connection.getAccountInfo(primaryPda);\n+  if (!info) return null;\n+  if (info.data.length < 8 + 32 + 32 + 1 + 1 + 1) {\n+    throw new Error(`invalid PrimaryName account data length at ${primaryPda.toBase58()}`);\n+  }\n+  const owner = new PublicKey(info.data.subarray(8, 8 + 32));\n+  const nameHashHex = Buffer.from(info.data.subarray(8 + 32, 8 + 64)).toString(\"hex\");\n+  const kind = info.data[8 + 64];\n+  const isSet = info.data[8 + 65] === 1;\n+  const bump = info.data[8 + 66];\n+  return { owner: owner.toBase58(), nameHashHex, kind, isSet, bump };\n+}\n+\n+async function main() {\n+  const argv = await yargs(hideBin(process.argv))\n+    .scriptName(\"names\")\n+    .option(\"rpc\", { type: \"string\", default: DEFAULT_RPC })\n+    .option(\"wallet\", { type: \"string\", default: DEFAULT_WALLET })\n+    .option(\"program-id\", { type: \"string\", describe: \"or use DDNS_NAMES_PROGRAM_ID / Anchor.toml\" })\n+    .command(\n+      \"init-config\",\n+      \"Initialize names config\",\n+      (y) =>\n+        y\n+          .option(\"treasury\", { type: \"string\", describe: \"default wallet\" })\n+          .option(\"parent-zone\", { type: \"string\", default: \"user.dns\" })\n+          .option(\"premium-price-sol\", { type: \"number\", default: 0.05 })\n+          .option(\"sub-bond-sol\", { type: \"number\", default: 0 })\n+          .option(\"enable-subdomains\", { type: \"boolean\", default: true })\n+          .option(\"enable-premium\", { type: \"boolean\", default: true }),\n+      async (args) => {\n+        const { program, payer, connection, programId } = await loadProgram(args.rpc as string, args.wallet as string, args[\"program-id\"] as string | undefined);\n+        const [configPda] = PublicKey.findProgramAddressSync([Buffer.from(\"names_config\")], programId);\n+\n+        const treasury = new PublicKey((args.treasury as string | undefined) || payer.publicKey.toBase58());\n+        const premiumPriceLamports = BigInt(Math.round((args[\"premium-price-sol\"] as number) * 1e9));\n+        const subBondLamports = BigInt(Math.round((args[\"sub-bond-sol\"] as number) * 1e9));\n+\n+        const sig = await program.methods\n+          .initNamesConfig(\n+            treasury,\n+            String(args[\"parent-zone\"]),\n+            new BN(premiumPriceLamports.toString()),\n+            new BN(subBondLamports.toString()),\n+            args[\"enable-subdomains\"] as boolean,\n+            args[\"enable-premium\"] as boolean\n+          )\n+          .accounts({\n+            config: configPda,\n+            authority: payer.publicKey,\n+            systemProgram: SystemProgram.programId,\n+          })\n+          .rpc();\n+\n+        console.log(JSON.stringify({\n+          tx: sig,\n+          programId: programId.toBase58(),\n+          configPda: configPda.toBase58(),\n+          treasury: treasury.toBase58(),\n+          parentZone: normalizeFullName(String(args[\"parent-zone\"])),\n+          premiumPriceLamports: premiumPriceLamports.toString(),\n+          subBondLamports: subBondLamports.toString(),\n+        }, null, 2));\n+      }\n+    )\n+    .command(\n+      \"claim-sub\",\n+      \"Claim subdomain under parent (default user.dns)\",\n+      (y) => y.option(\"label\", { type: \"string\", demandOption: true }).option(\"parent\", { type: \"string\", default: \"user.dns\" }),\n+      async (args) => {\n+        const { program, payer, programId } = await loadProgram(args.rpc as string, args.wallet as string, args[\"program-id\"] as string | undefined);","path":"solana/scripts/names.ts","commit_id":"d2ef3e134c5a862e89cc16236d81037f0ea649f3","original_commit_id":"81675831987de1eaa30b85b137b1473e90a2c7ad","user":{"login":"Copilot","id":175728472,"node_id":"BOT_kgDOCnlnWA","avatar_url":"https://avatars.githubusercontent.com/in/946600?v=4","gravatar_id":"","url":"https://api.github.com/users/Copilot","html_url":"https://github.com/apps/copilot-pull-request-reviewer","followers_url":"https://api.github.com/users/Copilot/followers","following_url":"https://api.github.com/users/Copilot/following{/other_user}","gists_url":"https://api.github.com/users/Copilot/gists{/gist_id}","starred_url":"https://api.github.com/users/Copilot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Copilot/subscriptions","organizations_url":"https://api.github.com/users/Copilot/orgs","repos_url":"https://api.github.com/users/Copilot/repos","events_url":"https://api.github.com/users/Copilot/events{/privacy}","received_events_url":"https://api.github.com/users/Copilot/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"Missing `connection` in destructuring assignment. The variable is used on line 154 in `fetchTreasuryFromConfig(connection, configPda)` but is not destructured from `loadProgram`. This will cause a ReferenceError at runtime. Add `connection` to the destructuring on this line, similar to how the \"buy-premium\" command does it on line 176.\n```suggestion\n        const { program, payer, programId, connection } = await loadProgram(args.rpc as string, args.wallet as string, args[\"program-id\"] as string | undefined);\n```","created_at":"2026-02-18T20:42:48Z","updated_at":"2026-02-18T20:42:49Z","html_url":"https://github.com/cwalinapj/DECENTRALIZED-DNS-/pull/71#discussion_r2824363461","pull_request_url":"https://api.github.com/repos/cwalinapj/DECENTRALIZED-DNS-/pulls/71","_links":{"self":{"href":"https://api.github.com/repos/cwalinapj/DECENTRALIZED-DNS-/pulls/comments/2824363461"},"html":{"href":"https://github.com/cwalinapj/DECENTRALIZED-DNS-/pull/71#discussion_r2824363461"},"pull_request":{"href":"https://api.github.com/repos/cwalinapj/DECENTRALIZED-DNS-/pulls/71"}},"reactions":{"url":"https://api.github.com/repos/cwalinapj/DECENTRALIZED-DNS-/pulls/comments/2824363461/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":145,"original_line":145,"side":"RIGHT","author_association":"NONE","original_position":145,"position":145,"subject_type":"line"}]