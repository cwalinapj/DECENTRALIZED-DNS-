[{"url":"https://api.github.com/repos/cwalinapj/DECENTRALIZED-DNS-/pulls/comments/2782039117","pull_request_review_id":3772692433,"id":2782039117,"node_id":"PRRC_kwDORKbd9s6l0oxN","diff_hunk":"@@ -0,0 +1,347 @@\n+import fs from \"node:fs\";\n+import path from \"node:path\";\n+import crypto from \"node:crypto\";\n+import yargs from \"yargs\";\n+import { hideBin } from \"yargs/helpers\";\n+import * as anchor from \"@coral-xyz/anchor\";\n+import { Connection, Keypair, PublicKey, SystemProgram } from \"@solana/web3.js\";\n+import BN from \"bn.js\";\n+import {\n+  TOKEN_PROGRAM_ID,\n+  createMint,\n+  getOrCreateAssociatedTokenAccount,\n+  mintTo,\n+} from \"@solana/spl-token\";\n+\n+function loadKeypair(filePath: string): Keypair {\n+  const raw = JSON.parse(fs.readFileSync(filePath, \"utf8\"));\n+  return Keypair.fromSecretKey(Uint8Array.from(raw));\n+}\n+\n+function loadIdl() {\n+  const idlPath = path.resolve(\"target/idl/ddns_miner_score.json\");\n+  if (!fs.existsSync(idlPath)) {\n+    throw new Error(`IDL not found at ${idlPath}. Run 'anchor build' in /solana first.`);\n+  }\n+  return JSON.parse(fs.readFileSync(idlPath, \"utf8\"));\n+}\n+\n+function readProgramIdFromAnchorToml(rpcUrl: string): string | null {\n+  try {\n+    const tomlPath = path.resolve(\"Anchor.toml\");\n+    if (!fs.existsSync(tomlPath)) return null;\n+    const content = fs.readFileSync(tomlPath, \"utf8\");\n+    const isLocal = /127\\\\.0\\\\.0\\\\.1|localhost/.test(rpcUrl);\n+    const section = isLocal ? \"programs.localnet\" : \"programs.devnet\";\n+    const re = new RegExp(\n+      `\\\\[${section}\\\\][^\\\\[]*?ddns_miner_score\\\\s*=\\\\s*\\\"([^\\\"]+)\\\"`,\n+      \"s\"\n+    );\n+    const match = content.match(re);\n+    return match ? match[1] : null;\n+  } catch {\n+    return null;\n+  }\n+}\n+\n+function sha256(buf: Buffer): Buffer {\n+  return crypto.createHash(\"sha256\").update(buf).digest();\n+}\n+\n+function u64le(n: bigint): Buffer {\n+  const b = Buffer.alloc(8);\n+  b.writeBigUInt64LE(n);\n+  return b;\n+}\n+\n+async function main() {\n+  const argv = await yargs(hideBin(process.argv))\n+    .command(\"init-config\", \"Init miner score config + reward vault\", (y) =>\n+      y\n+        .option(\"epoch-len-slots\", { type: \"number\", default: 100 })\n+        .option(\"base-reward\", { type: \"string\", default: \"0\" })\n+        .option(\"cap\", { type: \"string\", default: \"0\" })\n+        .option(\"min-stake-weight\", { type: \"string\", default: \"0\" })\n+        .option(\"toll-mint\", { type: \"string\", describe: \"defaults to new mint (localnet convenience)\" })\n+        .option(\"submitters\", { type: \"string\", describe: \"comma-separated pubkeys (default wallet)\" })\n+        .option(\"miners\", { type: \"string\", describe: \"comma-separated pubkeys (default wallet)\" })\n+        .option(\"diversity-target\", { type: \"number\", default: 100 })\n+        .option(\"alpha-correctness\", { type: \"number\", default: 5000 })\n+        .option(\"alpha-diversity\", { type: \"number\", default: 2000 })\n+        .option(\"alpha-timeliness\", { type: \"number\", default: 2000 })\n+        .option(\"alpha-uptime\", { type: \"number\", default: 1000 })\n+        .option(\"penalty-bps\", { type: \"number\", default: 2000 })\n+        .option(\"dominance-threshold-bps\", { type: \"number\", default: 2500 })\n+    )\n+    .command(\"report\", \"Report miner epoch stats\", (y) =>\n+      y\n+        .option(\"epoch\", { type: \"number\", demandOption: true })\n+        .option(\"miner\", { type: \"string\", demandOption: true })\n+        .option(\"stake-weight\", { type: \"string\", demandOption: true })\n+        .option(\"aggregates\", { type: \"number\", demandOption: true })\n+        .option(\"unique-names\", { type: \"number\", demandOption: true })\n+        .option(\"unique-receipts\", { type: \"number\", demandOption: true })\n+        .option(\"first-slot\", { type: \"number\", demandOption: true })\n+        .option(\"last-slot\", { type: \"number\", demandOption: true })\n+        .option(\"uptime\", { type: \"number\", default: 10000 })\n+        .option(\"correctness\", { type: \"number\", default: 10000 })\n+        .option(\"dominance\", { type: \"number\", default: 0 })\n+    )\n+    .command(\"finalize-epoch\", \"Finalize epoch totals (O(1))\", (y) =>\n+      y\n+        .option(\"epoch\", { type: \"number\", demandOption: true })\n+        .option(\"total-raw\", { type: \"string\", demandOption: true, describe: \"u128 decimal\" })\n+        .option(\"total-normalized\", { type: \"string\", demandOption: true, describe: \"u128 decimal\" })\n+        .option(\"pool\", { type: \"string\", demandOption: true, describe: \"u64 planned rewards (base units)\" })\n+        .option(\"miner-count\", { type: \"number\", demandOption: true })\n+        .option(\"dominance-max\", { type: \"number\", demandOption: true })\n+    )\n+    .command(\"set-reward\", \"Set a miner reward for an epoch\", (y) =>\n+      y\n+        .option(\"epoch\", { type: \"number\", demandOption: true })\n+        .option(\"miner\", { type: \"string\", demandOption: true })\n+        .option(\"normalized\", { type: \"string\", demandOption: true, describe: \"u128 decimal\" })\n+        .option(\"amount\", { type: \"string\", demandOption: true })\n+    )\n+    .command(\"claim\", \"Claim reward for wallet miner\", (y) =>\n+      y.option(\"epoch\", { type: \"number\", demandOption: true })\n+    )\n+    .command(\"penalize\", \"Apply a penalty (reduces reward if not claimed)\", (y) =>\n+      y\n+        .option(\"epoch\", { type: \"number\", demandOption: true })\n+        .option(\"miner\", { type: \"string\", demandOption: true })\n+        .option(\"penalty-bps\", { type: \"number\", demandOption: true })\n+        .option(\"reason\", { type: \"string\", demandOption: true })\n+    )\n+    .option(\"rpc\", { type: \"string\" })\n+    .option(\"wallet\", { type: \"string\" })\n+    .option(\"program-id\", { type: \"string\" })\n+    .demandCommand(1)\n+    .strict()\n+    .parse();\n+\n+  if (argv.rpc) process.env.ANCHOR_PROVIDER_URL = argv.rpc;\n+  if (argv.wallet) process.env.ANCHOR_WALLET = argv.wallet;\n+\n+  const rpcUrl = process.env.ANCHOR_PROVIDER_URL || \"https://api.devnet.solana.com\";\n+  const walletPath =\n+    process.env.ANCHOR_WALLET || path.join(process.env.HOME || \".\", \".config/solana/id.json\");\n+\n+  const payer = loadKeypair(walletPath);\n+  const connection = new Connection(rpcUrl, \"confirmed\");\n+  const provider = new anchor.AnchorProvider(connection, new anchor.Wallet(payer), {\n+    commitment: \"confirmed\",\n+  });\n+  anchor.setProvider(provider);\n+\n+  const idl = loadIdl();\n+  const programIdStr =\n+    (argv[\"program-id\"] as string | undefined) ||\n+    process.env.DDNS_MINER_SCORE_PROGRAM_ID ||\n+    readProgramIdFromAnchorToml(rpcUrl);\n+  if (!programIdStr) throw new Error(\"program id not found (set --program-id or DDNS_MINER_SCORE_PROGRAM_ID)\");\n+  const programId = new PublicKey(programIdStr);\n+  const program = new anchor.Program(idl as any, programId, provider);\n+\n+  const [configPda] = PublicKey.findProgramAddressSync([Buffer.from(\"miner_score_config\")], programId);\n+  const [vaultAuthority] = PublicKey.findProgramAddressSync([Buffer.from(\"miner_score_vault_authority\")], programId);\n+  const [rewardVaultPda] = PublicKey.findProgramAddressSync([Buffer.from(\"reward_vault\")], programId);\n+\n+  const cmd = argv._[0];\n+\n+  if (cmd === \"init-config\") {\n+    let tollMint = argv[\"toll-mint\"] ? new PublicKey(argv[\"toll-mint\"] as string) : null;\n+    if (!tollMint) {\n+      tollMint = await createMint(connection, payer, payer.publicKey, null, 9);\n+      const ata = await getOrCreateAssociatedTokenAccount(connection, payer, tollMint, payer.publicKey);\n+      await mintTo(connection, payer, tollMint, ata.address, payer, 1_000_000_000_000n);\n+      console.log(\"created toll_mint:\", tollMint.toBase58());\n+    }","path":"solana/scripts/miner_score.ts","commit_id":"b4177e6c2f4f33c69b0d1b926a209755707e1728","original_commit_id":"b4177e6c2f4f33c69b0d1b926a209755707e1728","user":{"login":"Copilot","id":175728472,"node_id":"BOT_kgDOCnlnWA","avatar_url":"https://avatars.githubusercontent.com/in/946600?v=4","gravatar_id":"","url":"https://api.github.com/users/Copilot","html_url":"https://github.com/apps/copilot-pull-request-reviewer","followers_url":"https://api.github.com/users/Copilot/followers","following_url":"https://api.github.com/users/Copilot/following{/other_user}","gists_url":"https://api.github.com/users/Copilot/gists{/gist_id}","starred_url":"https://api.github.com/users/Copilot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Copilot/subscriptions","organizations_url":"https://api.github.com/users/Copilot/orgs","repos_url":"https://api.github.com/users/Copilot/repos","events_url":"https://api.github.com/users/Copilot/events{/privacy}","received_events_url":"https://api.github.com/users/Copilot/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"`init-config` creates a new localnet mint and mints tokens to the payer's ATA, but the on-chain `claim_miner_reward` pays from `config.reward_vault`. Without an explicit step to fund the reward vault, `claim` will fail due to insufficient funds. Consider minting directly to `rewardVaultPda` on localnet, or add a `fund-vault`/`deposit` command and document it.","created_at":"2026-02-09T11:11:16Z","updated_at":"2026-02-09T11:11:20Z","html_url":"https://github.com/cwalinapj/DECENTRALIZED-DNS-/pull/51#discussion_r2782039117","pull_request_url":"https://api.github.com/repos/cwalinapj/DECENTRALIZED-DNS-/pulls/51","_links":{"self":{"href":"https://api.github.com/repos/cwalinapj/DECENTRALIZED-DNS-/pulls/comments/2782039117"},"html":{"href":"https://github.com/cwalinapj/DECENTRALIZED-DNS-/pull/51#discussion_r2782039117"},"pull_request":{"href":"https://api.github.com/repos/cwalinapj/DECENTRALIZED-DNS-/pulls/51"}},"reactions":{"url":"https://api.github.com/repos/cwalinapj/DECENTRALIZED-DNS-/pulls/comments/2782039117/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":154,"original_start_line":154,"start_side":"RIGHT","line":159,"original_line":159,"side":"RIGHT","author_association":"NONE","original_position":159,"position":159,"subject_type":"line"},{"url":"https://api.github.com/repos/cwalinapj/DECENTRALIZED-DNS-/pulls/comments/2782039147","pull_request_review_id":3772692433,"id":2782039147,"node_id":"PRRC_kwDORKbd9s6l0oxr","diff_hunk":"@@ -0,0 +1,160 @@\n+import fs from \"node:fs\";\n+import path from \"node:path\";\n+import express from \"express\";\n+import { z } from \"zod\";\n+import * as anchor from \"@coral-xyz/anchor\";\n+import { Connection, Keypair, PublicKey } from \"@solana/web3.js\";\n+import BN from \"bn.js\";\n+\n+const Env = z.object({\n+  RPC_URL: z.string().default(\"https://api.devnet.solana.com\"),\n+  MINER_WALLET: z.string().optional(),\n+  DDNS_MINER_SCORE_PROGRAM_ID: z.string().optional(),\n+  PORT: z.string().default(\"8787\"),\n+});\n+\n+function loadKeypair(filePath: string): Keypair {\n+  const raw = JSON.parse(fs.readFileSync(filePath, \"utf8\"));\n+  return Keypair.fromSecretKey(Uint8Array.from(raw));\n+}\n+\n+function loadIdl(idlPath: string) {\n+  if (!fs.existsSync(idlPath)) {\n+    throw new Error(`IDL not found at ${idlPath}. Run 'anchor build' in /solana first.`);\n+  }\n+  return JSON.parse(fs.readFileSync(idlPath, \"utf8\"));\n+}\n+\n+function u64le(n: bigint): Buffer {\n+  const b = Buffer.alloc(8);\n+  b.writeBigUInt64LE(n);\n+  return b;\n+}\n+\n+const ReportSchema = z.object({\n+  epoch_id: z.number().int().nonnegative(),\n+  miner: z.string(),\n+  stake_weight: z.string(),\n+  aggregates_submitted: z.number().int().nonnegative(),\n+  unique_name_count: z.number().int().nonnegative(),\n+  unique_receipt_count: z.number().int().nonnegative(),\n+  first_submit_slot: z.number().int().nonnegative(),\n+  last_submit_slot: z.number().int().nonnegative(),\n+  uptime_score: z.number().int().min(0).max(10000).default(10000),\n+  correctness_score: z.number().int().min(0).max(10000).default(10000),\n+  dominance_share_bps: z.number().int().min(0).max(10000).default(0),\n+});\n+\n+async function main() {\n+  const env = Env.parse({\n+    RPC_URL: process.env.SOLANA_RPC_URL || process.env.RPC_URL,\n+    MINER_WALLET: process.env.MINER_WALLET,\n+    DDNS_MINER_SCORE_PROGRAM_ID: process.env.DDNS_MINER_SCORE_PROGRAM_ID,\n+    PORT: process.env.PORT,\n+  });\n+\n+  const walletPath =\n+    env.MINER_WALLET ||\n+    process.env.ANCHOR_WALLET ||\n+    path.join(process.env.HOME || \".\", \".config/solana/id.json\");\n+\n+  const rpcUrl = env.RPC_URL;\n+\n+  const keypair = loadKeypair(walletPath);\n+  const connection = new Connection(rpcUrl, \"confirmed\");\n+  const provider = new anchor.AnchorProvider(connection, new anchor.Wallet(keypair), {\n+    commitment: \"confirmed\",\n+  });\n+  anchor.setProvider(provider);\n+\n+  const idl = loadIdl(\n+    path.resolve(process.cwd(), \"..\", \"..\", \"solana\", \"target\", \"idl\", \"ddns_miner_score.json\")\n+  );\n+\n+  const programIdStr =\n+    env.DDNS_MINER_SCORE_PROGRAM_ID ||\n+    process.env.DDNS_MINER_SCORE_PROGRAM_ID ||\n+    (idl?.metadata?.address as string | undefined);\n+  if (!programIdStr) {\n+    throw new Error(\n+      \"DDNS_MINER_SCORE_PROGRAM_ID not set and not found in IDL metadata\"\n+    );\n+  }\n+  const programId = new PublicKey(programIdStr);\n+  const program = new anchor.Program(idl as any, programId, provider);\n+\n+  const [configPda] = PublicKey.findProgramAddressSync(\n+    [Buffer.from(\"miner_score_config\")],\n+    programId\n+  );\n+\n+  const app = express();\n+  app.disable(\"x-powered-by\");\n+  app.use(express.json({ limit: \"256kb\" }));\n+\n+  app.get(\"/v1/health\", (_req, res) => res.json({ ok: true }));\n+\n+  // MVP: this service just submits stats (it does not prove them on-chain).\n+  // End-state: stats will be accompanied by Merkle proofs and/or challenged.\n+  app.post(\"/v1/report-epoch-stats\", async (req, res) => {\n+    try {\n+      const body = ReportSchema.parse(req.body);\n+      const miner = new PublicKey(body.miner);\n+      const epochId = BigInt(body.epoch_id);\n+      const [minerEpochPda] = PublicKey.findProgramAddressSync(\n+        [Buffer.from(\"miner_epoch\"), u64le(epochId), miner.toBuffer()],\n+        programId\n+      );","path":"services/miner-witness/src/index.ts","commit_id":"b4177e6c2f4f33c69b0d1b926a209755707e1728","original_commit_id":"b4177e6c2f4f33c69b0d1b926a209755707e1728","user":{"login":"Copilot","id":175728472,"node_id":"BOT_kgDOCnlnWA","avatar_url":"https://avatars.githubusercontent.com/in/946600?v=4","gravatar_id":"","url":"https://api.github.com/users/Copilot","html_url":"https://github.com/apps/copilot-pull-request-reviewer","followers_url":"https://api.github.com/users/Copilot/followers","following_url":"https://api.github.com/users/Copilot/following{/other_user}","gists_url":"https://api.github.com/users/Copilot/gists{/gist_id}","starred_url":"https://api.github.com/users/Copilot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Copilot/subscriptions","organizations_url":"https://api.github.com/users/Copilot/orgs","repos_url":"https://api.github.com/users/Copilot/repos","events_url":"https://api.github.com/users/Copilot/events{/privacy}","received_events_url":"https://api.github.com/users/Copilot/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"This endpoint submits on-chain `reportMinerEpochStats` transactions using the service's hot wallet (an allowlisted submitter). With no request authentication/authorization, any caller who can reach this HTTP endpoint can cause arbitrary reports to be posted (and can DoS legitimate submissions by pre-creating the `miner_epoch` PDA). Add an auth layer (e.g., shared secret/API key, request signing, IP allowlist, or mTLS) and reject unauthenticated calls.","created_at":"2026-02-09T11:11:17Z","updated_at":"2026-02-09T11:11:20Z","html_url":"https://github.com/cwalinapj/DECENTRALIZED-DNS-/pull/51#discussion_r2782039147","pull_request_url":"https://api.github.com/repos/cwalinapj/DECENTRALIZED-DNS-/pulls/51","_links":{"self":{"href":"https://api.github.com/repos/cwalinapj/DECENTRALIZED-DNS-/pulls/comments/2782039147"},"html":{"href":"https://github.com/cwalinapj/DECENTRALIZED-DNS-/pull/51#discussion_r2782039147"},"pull_request":{"href":"https://api.github.com/repos/cwalinapj/DECENTRALIZED-DNS-/pulls/51"}},"reactions":{"url":"https://api.github.com/repos/cwalinapj/DECENTRALIZED-DNS-/pulls/comments/2782039147/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":97,"original_start_line":97,"start_side":"RIGHT","line":107,"original_line":107,"side":"RIGHT","author_association":"NONE","original_position":107,"position":107,"subject_type":"line"},{"url":"https://api.github.com/repos/cwalinapj/DECENTRALIZED-DNS-/pulls/comments/2782039170","pull_request_review_id":3772692433,"id":2782039170,"node_id":"PRRC_kwDORKbd9s6l0oyC","diff_hunk":"@@ -0,0 +1,160 @@\n+import fs from \"node:fs\";\n+import path from \"node:path\";\n+import express from \"express\";\n+import { z } from \"zod\";\n+import * as anchor from \"@coral-xyz/anchor\";\n+import { Connection, Keypair, PublicKey } from \"@solana/web3.js\";\n+import BN from \"bn.js\";\n+\n+const Env = z.object({\n+  RPC_URL: z.string().default(\"https://api.devnet.solana.com\"),\n+  MINER_WALLET: z.string().optional(),\n+  DDNS_MINER_SCORE_PROGRAM_ID: z.string().optional(),\n+  PORT: z.string().default(\"8787\"),","path":"services/miner-witness/src/index.ts","commit_id":"b4177e6c2f4f33c69b0d1b926a209755707e1728","original_commit_id":"b4177e6c2f4f33c69b0d1b926a209755707e1728","user":{"login":"Copilot","id":175728472,"node_id":"BOT_kgDOCnlnWA","avatar_url":"https://avatars.githubusercontent.com/in/946600?v=4","gravatar_id":"","url":"https://api.github.com/users/Copilot","html_url":"https://github.com/apps/copilot-pull-request-reviewer","followers_url":"https://api.github.com/users/Copilot/followers","following_url":"https://api.github.com/users/Copilot/following{/other_user}","gists_url":"https://api.github.com/users/Copilot/gists{/gist_id}","starred_url":"https://api.github.com/users/Copilot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Copilot/subscriptions","organizations_url":"https://api.github.com/users/Copilot/orgs","repos_url":"https://api.github.com/users/Copilot/repos","events_url":"https://api.github.com/users/Copilot/events{/privacy}","received_events_url":"https://api.github.com/users/Copilot/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"`MINER_WALLET` is used as the submitter/service keypair (i.e., the allowlisted submitter that pays rent and signs transactions), not the miner being reported. This name is likely to confuse operators and increases the chance of misconfiguration. Consider renaming to something like `SUBMITTER_WALLET` (keeping backward compatibility if needed).","created_at":"2026-02-09T11:11:17Z","updated_at":"2026-02-09T11:11:20Z","html_url":"https://github.com/cwalinapj/DECENTRALIZED-DNS-/pull/51#discussion_r2782039170","pull_request_url":"https://api.github.com/repos/cwalinapj/DECENTRALIZED-DNS-/pulls/51","_links":{"self":{"href":"https://api.github.com/repos/cwalinapj/DECENTRALIZED-DNS-/pulls/comments/2782039170"},"html":{"href":"https://github.com/cwalinapj/DECENTRALIZED-DNS-/pull/51#discussion_r2782039170"},"pull_request":{"href":"https://api.github.com/repos/cwalinapj/DECENTRALIZED-DNS-/pulls/51"}},"reactions":{"url":"https://api.github.com/repos/cwalinapj/DECENTRALIZED-DNS-/pulls/comments/2782039170/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":9,"original_start_line":9,"start_side":"RIGHT","line":13,"original_line":13,"side":"RIGHT","author_association":"NONE","original_position":13,"position":13,"subject_type":"line"},{"url":"https://api.github.com/repos/cwalinapj/DECENTRALIZED-DNS-/pulls/comments/2782039194","pull_request_review_id":3772692433,"id":2782039194,"node_id":"PRRC_kwDORKbd9s6l0oya","diff_hunk":"@@ -0,0 +1,288 @@\n+import * as anchor from \"@coral-xyz/anchor\";\n+import { Program } from \"@coral-xyz/anchor\";\n+import { Keypair, PublicKey } from \"@solana/web3.js\";\n+import {\n+  createMint,\n+  getAccount,\n+  getOrCreateAssociatedTokenAccount,\n+  mintTo,\n+  TOKEN_PROGRAM_ID,\n+} from \"@solana/spl-token\";\n+import { expect } from \"chai\";\n+import BN from \"bn.js\";\n+\n+function u64le(n: bigint): Buffer {\n+  const b = Buffer.alloc(8);\n+  b.writeBigUInt64LE(n);\n+  return b;\n+}\n+\n+describe(\"ddns_miner_score\", () => {\n+  const provider = anchor.AnchorProvider.env();\n+  anchor.setProvider(provider);\n+\n+  const program = anchor.workspace.DdnsMinerScore as Program;\n+\n+  it(\"reports stats, finalizes epoch, sets rewards, claims, penalizes\", async () => {\n+    const feePayer = provider.wallet.publicKey;\n+    const feePayerKp = (provider.wallet as any).payer as Keypair;\n+\n+    const [configPda] = PublicKey.findProgramAddressSync(\n+      [Buffer.from(\"miner_score_config\")],\n+      program.programId\n+    );\n+    const [vaultAuthority] = PublicKey.findProgramAddressSync(\n+      [Buffer.from(\"miner_score_vault_authority\")],\n+      program.programId\n+    );\n+    const [rewardVaultPda] = PublicKey.findProgramAddressSync(\n+      [Buffer.from(\"reward_vault\")],\n+      program.programId\n+    );\n+\n+    const tollMint = await createMint(\n+      provider.connection,\n+      feePayerKp,\n+      feePayer,\n+      null,\n+      9\n+    );\n+\n+    // Init config (allowlisted submitter = fee payer).\n+    const minerA = Keypair.generate();\n+    const minerB = Keypair.generate();\n+    const minerC = Keypair.generate();\n+\n+    await program.methods\n+      .initMinerScoreConfig(\n+        new BN(100), // epoch_len_slots\n+        new BN(0),\n+        new BN(50n * 10n ** 9n), // per miner cap\n+        new BN(1), // min stake weight\n+        [feePayer],\n+        [minerA.publicKey, minerB.publicKey, minerC.publicKey],\n+        5000,\n+        2000,\n+        2000,\n+        1000,\n+        2000,\n+        2500,\n+        100\n+      )\n+      .accounts({\n+        config: configPda,\n+        vaultAuthority,\n+        tollMint,\n+        rewardVault: rewardVaultPda,\n+        authority: feePayer,\n+        tokenProgram: TOKEN_PROGRAM_ID,\n+        systemProgram: anchor.web3.SystemProgram.programId,\n+        rent: anchor.web3.SYSVAR_RENT_PUBKEY,\n+      })\n+      .rpc();\n+\n+    // Fund reward vault.\n+    await mintTo(\n+      provider.connection,\n+      feePayerKp,\n+      tollMint,\n+      rewardVaultPda,\n+      feePayer,\n+      1_000_000_000_000n\n+    );\n+\n+    const epochId = 1n;\n+    const epochStart = 100n;\n+    const epochEnd = 200n;\n+\n+    // Miner A dominates volume -> dominance_share_bps high triggers penalty in raw_score.\n+    const [aPda] = PublicKey.findProgramAddressSync(\n+      [Buffer.from(\"miner_epoch\"), u64le(epochId), minerA.publicKey.toBuffer()],\n+      program.programId\n+    );\n+    const [bPda] = PublicKey.findProgramAddressSync(\n+      [Buffer.from(\"miner_epoch\"), u64le(epochId), minerB.publicKey.toBuffer()],\n+      program.programId\n+    );\n+    const [cPda] = PublicKey.findProgramAddressSync(\n+      [Buffer.from(\"miner_epoch\"), u64le(epochId), minerC.publicKey.toBuffer()],\n+      program.programId\n+    );\n+\n+    await program.methods\n+      .reportMinerEpochStats(\n+        new BN(epochId.toString()),\n+        minerA.publicKey,\n+        new BN(1000),\n+        50,\n+        10,\n+        500,\n+        new BN((epochStart + 1n).toString()),\n+        new BN((epochEnd - 1n).toString()),\n+        9000,\n+        10000,\n+        4000\n+      )\n+      .accounts({\n+        config: configPda,\n+        minerEpoch: aPda,\n+        submitter: feePayer,\n+        systemProgram: anchor.web3.SystemProgram.programId,\n+      })\n+      .rpc();\n+\n+    await program.methods\n+      .reportMinerEpochStats(\n+        new BN(epochId.toString()),\n+        minerB.publicKey,\n+        new BN(1000),\n+        20,\n+        40,\n+        400,\n+        new BN((epochStart + 5n).toString()),\n+        new BN((epochEnd - 2n).toString()),\n+        9500,\n+        10000,\n+        2000\n+      )\n+      .accounts({\n+        config: configPda,\n+        minerEpoch: bPda,\n+        submitter: feePayer,\n+        systemProgram: anchor.web3.SystemProgram.programId,\n+      })\n+      .rpc();\n+\n+    await program.methods\n+      .reportMinerEpochStats(\n+        new BN(epochId.toString()),\n+        minerC.publicKey,\n+        new BN(500),\n+        10,\n+        90,\n+        300,\n+        new BN((epochStart + 2n).toString()),\n+        new BN((epochEnd - 3n).toString()),\n+        9800,\n+        10000,\n+        1000\n+      )\n+      .accounts({\n+        config: configPda,\n+        minerEpoch: cPda,\n+        submitter: feePayer,\n+        systemProgram: anchor.web3.SystemProgram.programId,\n+      })\n+      .rpc();\n+\n+    const aStats: any = await program.account.minerEpochStats.fetch(aPda);\n+    const bStats: any = await program.account.minerEpochStats.fetch(bPda);\n+    const cStats: any = await program.account.minerEpochStats.fetch(cPda);\n+    expect(aStats.rawScore.gt(new BN(0))).to.equal(true);\n+    expect(bStats.rawScore.gt(new BN(0))).to.equal(true);\n+    expect(cStats.rawScore.gt(new BN(0))).to.equal(true);\n+\n+    // Finalize epoch totals (values supplied off-chain in MVP).\n+    const [totalsPda] = PublicKey.findProgramAddressSync(\n+      [Buffer.from(\"epoch_totals\"), u64le(epochId)],\n+      program.programId\n+    );\n+    await program.methods\n+      .finalizeEpoch(\n+        new BN(epochId.toString()),\n+        new BN(aStats.rawScore.add(bStats.rawScore).add(cStats.rawScore).toString()),\n+        new BN(\"1\"),\n+        new BN(\"0\"),\n+        3,\n+        4000\n+      )\n+      .accounts({\n+        config: configPda,\n+        epochTotals: totalsPda,\n+        submitter: feePayer,\n+        systemProgram: anchor.web3.SystemProgram.programId,\n+      })\n+      .rpc();\n+\n+    // Set rewards (simulate off-chain quadratic allocation). Keep within cap.\n+    await program.methods\n+      .setMinerReward(new BN(epochId.toString()), minerA.publicKey, new BN(\"1\"), new BN(10n * 10n ** 9n))\n+      .accounts({ config: configPda, epochTotals: totalsPda, minerEpoch: aPda, submitter: feePayer })\n+      .rpc();\n+    await program.methods\n+      .setMinerReward(new BN(epochId.toString()), minerB.publicKey, new BN(\"1\"), new BN(20n * 10n ** 9n))\n+      .accounts({ config: configPda, epochTotals: totalsPda, minerEpoch: bPda, submitter: feePayer })\n+      .rpc();\n+    await program.methods\n+      .setMinerReward(new BN(epochId.toString()), minerC.publicKey, new BN(\"1\"), new BN(30n * 10n ** 9n))\n+      .accounts({ config: configPda, epochTotals: totalsPda, minerEpoch: cPda, submitter: feePayer })\n+      .rpc();\n+\n+    // Penalize miner A before claim and check reward reduced.\n+    const aBefore: any = await program.account.minerEpochStats.fetch(aPda);\n+    const reasonHash = Buffer.alloc(32, 8);\n+    await program.methods\n+      .penalizeMiner(new BN(epochId.toString()), minerA.publicKey, 5000, Array.from(reasonHash) as any)\n+      .accounts({ config: configPda, minerEpoch: aPda, submitter: feePayer })\n+      .rpc();\n+    const aAfter: any = await program.account.minerEpochStats.fetch(aPda);\n+    expect(aAfter.rewardAmount.lt(aBefore.rewardAmount)).to.equal(true);\n+\n+    // Claim miner B reward.\n+    const bAta = await getOrCreateAssociatedTokenAccount(\n+      provider.connection,\n+      feePayerKp,\n+      tollMint,\n+      minerB.publicKey\n+    );\n+    await provider.connection.requestAirdrop(minerB.publicKey, 2e9);\n+    await new Promise((r) => setTimeout(r, 800));\n+    const [bClaimPda] = PublicKey.findProgramAddressSync(","path":"solana/tests/ddns_miner_score.ts","commit_id":"b4177e6c2f4f33c69b0d1b926a209755707e1728","original_commit_id":"b4177e6c2f4f33c69b0d1b926a209755707e1728","user":{"login":"Copilot","id":175728472,"node_id":"BOT_kgDOCnlnWA","avatar_url":"https://avatars.githubusercontent.com/in/946600?v=4","gravatar_id":"","url":"https://api.github.com/users/Copilot","html_url":"https://github.com/apps/copilot-pull-request-reviewer","followers_url":"https://api.github.com/users/Copilot/followers","following_url":"https://api.github.com/users/Copilot/following{/other_user}","gists_url":"https://api.github.com/users/Copilot/gists{/gist_id}","starred_url":"https://api.github.com/users/Copilot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Copilot/subscriptions","organizations_url":"https://api.github.com/users/Copilot/orgs","repos_url":"https://api.github.com/users/Copilot/repos","events_url":"https://api.github.com/users/Copilot/events{/privacy}","received_events_url":"https://api.github.com/users/Copilot/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"The test uses `requestAirdrop` followed by a fixed `setTimeout(800ms)` before sending the claim transaction. This is timing-dependent and can be flaky on slower CI/local machines. Prefer awaiting confirmation via `confirmTransaction` (or `provider.connection.confirmTransaction`) using the airdrop signature.","created_at":"2026-02-09T11:11:17Z","updated_at":"2026-02-09T11:11:20Z","html_url":"https://github.com/cwalinapj/DECENTRALIZED-DNS-/pull/51#discussion_r2782039194","pull_request_url":"https://api.github.com/repos/cwalinapj/DECENTRALIZED-DNS-/pulls/51","_links":{"self":{"href":"https://api.github.com/repos/cwalinapj/DECENTRALIZED-DNS-/pulls/comments/2782039194"},"html":{"href":"https://github.com/cwalinapj/DECENTRALIZED-DNS-/pull/51#discussion_r2782039194"},"pull_request":{"href":"https://api.github.com/repos/cwalinapj/DECENTRALIZED-DNS-/pulls/51"}},"reactions":{"url":"https://api.github.com/repos/cwalinapj/DECENTRALIZED-DNS-/pulls/comments/2782039194/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":238,"original_start_line":238,"start_side":"RIGHT","line":240,"original_line":240,"side":"RIGHT","author_association":"NONE","original_position":240,"position":240,"subject_type":"line"},{"url":"https://api.github.com/repos/cwalinapj/DECENTRALIZED-DNS-/pulls/comments/2782039213","pull_request_review_id":3772692433,"id":2782039213,"node_id":"PRRC_kwDORKbd9s6l0oyt","diff_hunk":"@@ -0,0 +1,28 @@\n+# MVP (What Works / What Is Centralized)\n+\n+This doc contains: **MVP âœ…** and references to **End-State ðŸ”®** (not implemented).\n+","path":"docs/MVP.md","commit_id":"b4177e6c2f4f33c69b0d1b926a209755707e1728","original_commit_id":"b4177e6c2f4f33c69b0d1b926a209755707e1728","user":{"login":"Copilot","id":175728472,"node_id":"BOT_kgDOCnlnWA","avatar_url":"https://avatars.githubusercontent.com/in/946600?v=4","gravatar_id":"","url":"https://api.github.com/users/Copilot","html_url":"https://github.com/apps/copilot-pull-request-reviewer","followers_url":"https://api.github.com/users/Copilot/followers","following_url":"https://api.github.com/users/Copilot/following{/other_user}","gists_url":"https://api.github.com/users/Copilot/gists{/gist_id}","starred_url":"https://api.github.com/users/Copilot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Copilot/subscriptions","organizations_url":"https://api.github.com/users/Copilot/orgs","repos_url":"https://api.github.com/users/Copilot/repos","events_url":"https://api.github.com/users/Copilot/events{/privacy}","received_events_url":"https://api.github.com/users/Copilot/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"Line length: this paragraph exceeds the repoâ€™s markdownlint MD013 limit (80 chars) and will fail CI. Wrap the sentence onto multiple lines.","created_at":"2026-02-09T11:11:18Z","updated_at":"2026-02-09T11:11:20Z","html_url":"https://github.com/cwalinapj/DECENTRALIZED-DNS-/pull/51#discussion_r2782039213","pull_request_url":"https://api.github.com/repos/cwalinapj/DECENTRALIZED-DNS-/pulls/51","_links":{"self":{"href":"https://api.github.com/repos/cwalinapj/DECENTRALIZED-DNS-/pulls/comments/2782039213"},"html":{"href":"https://github.com/cwalinapj/DECENTRALIZED-DNS-/pull/51#discussion_r2782039213"},"pull_request":{"href":"https://api.github.com/repos/cwalinapj/DECENTRALIZED-DNS-/pulls/51"}},"reactions":{"url":"https://api.github.com/repos/cwalinapj/DECENTRALIZED-DNS-/pulls/comments/2782039213/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":1,"original_start_line":1,"start_side":"RIGHT","line":4,"original_line":4,"side":"RIGHT","author_association":"NONE","original_position":4,"position":4,"subject_type":"line"},{"url":"https://api.github.com/repos/cwalinapj/DECENTRALIZED-DNS-/pulls/comments/2782039233","pull_request_review_id":3772692433,"id":2782039233,"node_id":"PRRC_kwDORKbd9s6l0ozB","diff_hunk":"@@ -0,0 +1,160 @@\n+import fs from \"node:fs\";\n+import path from \"node:path\";\n+import express from \"express\";\n+import { z } from \"zod\";\n+import * as anchor from \"@coral-xyz/anchor\";\n+import { Connection, Keypair, PublicKey } from \"@solana/web3.js\";\n+import BN from \"bn.js\";\n+\n+const Env = z.object({\n+  RPC_URL: z.string().default(\"https://api.devnet.solana.com\"),\n+  MINER_WALLET: z.string().optional(),\n+  DDNS_MINER_SCORE_PROGRAM_ID: z.string().optional(),\n+  PORT: z.string().default(\"8787\"),\n+});\n+\n+function loadKeypair(filePath: string): Keypair {\n+  const raw = JSON.parse(fs.readFileSync(filePath, \"utf8\"));\n+  return Keypair.fromSecretKey(Uint8Array.from(raw));\n+}\n+\n+function loadIdl(idlPath: string) {\n+  if (!fs.existsSync(idlPath)) {\n+    throw new Error(`IDL not found at ${idlPath}. Run 'anchor build' in /solana first.`);\n+  }\n+  return JSON.parse(fs.readFileSync(idlPath, \"utf8\"));\n+}\n+\n+function u64le(n: bigint): Buffer {\n+  const b = Buffer.alloc(8);\n+  b.writeBigUInt64LE(n);\n+  return b;\n+}\n+\n+const ReportSchema = z.object({\n+  epoch_id: z.number().int().nonnegative(),\n+  miner: z.string(),\n+  stake_weight: z.string(),\n+  aggregates_submitted: z.number().int().nonnegative(),\n+  unique_name_count: z.number().int().nonnegative(),\n+  unique_receipt_count: z.number().int().nonnegative(),\n+  first_submit_slot: z.number().int().nonnegative(),\n+  last_submit_slot: z.number().int().nonnegative(),\n+  uptime_score: z.number().int().min(0).max(10000).default(10000),\n+  correctness_score: z.number().int().min(0).max(10000).default(10000),\n+  dominance_share_bps: z.number().int().min(0).max(10000).default(0),\n+});","path":"services/miner-witness/src/index.ts","commit_id":"b4177e6c2f4f33c69b0d1b926a209755707e1728","original_commit_id":"b4177e6c2f4f33c69b0d1b926a209755707e1728","user":{"login":"Copilot","id":175728472,"node_id":"BOT_kgDOCnlnWA","avatar_url":"https://avatars.githubusercontent.com/in/946600?v=4","gravatar_id":"","url":"https://api.github.com/users/Copilot","html_url":"https://github.com/apps/copilot-pull-request-reviewer","followers_url":"https://api.github.com/users/Copilot/followers","following_url":"https://api.github.com/users/Copilot/following{/other_user}","gists_url":"https://api.github.com/users/Copilot/gists{/gist_id}","starred_url":"https://api.github.com/users/Copilot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Copilot/subscriptions","organizations_url":"https://api.github.com/users/Copilot/orgs","repos_url":"https://api.github.com/users/Copilot/repos","events_url":"https://api.github.com/users/Copilot/events{/privacy}","received_events_url":"https://api.github.com/users/Copilot/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"`epoch_id`, `first_submit_slot`, and `last_submit_slot` are parsed as `number`s. Solana epochs/slots are u64 and can exceed JS safe integer range, leading to precision loss and incorrect PDAs / on-chain values. Accept these fields as strings and convert via `BigInt`/`BN` from string.","created_at":"2026-02-09T11:11:18Z","updated_at":"2026-02-09T11:11:20Z","html_url":"https://github.com/cwalinapj/DECENTRALIZED-DNS-/pull/51#discussion_r2782039233","pull_request_url":"https://api.github.com/repos/cwalinapj/DECENTRALIZED-DNS-/pulls/51","_links":{"self":{"href":"https://api.github.com/repos/cwalinapj/DECENTRALIZED-DNS-/pulls/comments/2782039233"},"html":{"href":"https://github.com/cwalinapj/DECENTRALIZED-DNS-/pull/51#discussion_r2782039233"},"pull_request":{"href":"https://api.github.com/repos/cwalinapj/DECENTRALIZED-DNS-/pulls/51"}},"reactions":{"url":"https://api.github.com/repos/cwalinapj/DECENTRALIZED-DNS-/pulls/comments/2782039233/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":34,"original_start_line":34,"start_side":"RIGHT","line":46,"original_line":46,"side":"RIGHT","author_association":"NONE","original_position":46,"position":46,"subject_type":"line"},{"url":"https://api.github.com/repos/cwalinapj/DECENTRALIZED-DNS-/pulls/comments/2782039250","pull_request_review_id":3772692433,"id":2782039250,"node_id":"PRRC_kwDORKbd9s6l0ozS","diff_hunk":"@@ -0,0 +1,123 @@\n+# Miner Scoring (MVP) and Anti-Centralization Incentives\n+\n+This doc contains: **MVP âœ…** and **End-State ðŸ”®**.\n+\n+## What This Solves\n+\n+We want miner/verifier incentives that:\n+\n+- reward correct, available, responsive operators\n+- discourage a single miner from dominating submissions and rewards\n+- remain MVP-feasible (receipt verification off-chain; on-chain checks lightweight)\n+\n+On-chain program: `ddns_miner_score` (Solana / Anchor)\n+\n+## MVP Summary (Trust Model)\n+\n+**MVP âœ…**\n+- Receipts and aggregate correctness are verified **off-chain** by miners/watchers.\n+- On-chain accepts per-epoch miner stats + reward assignments from **allowlisted submitters**.\n+- Rewards are paid in `TOLL` from an on-chain vault to miner token accounts.","path":"docs/MINER_SCORING.md","commit_id":"b4177e6c2f4f33c69b0d1b926a209755707e1728","original_commit_id":"b4177e6c2f4f33c69b0d1b926a209755707e1728","user":{"login":"Copilot","id":175728472,"node_id":"BOT_kgDOCnlnWA","avatar_url":"https://avatars.githubusercontent.com/in/946600?v=4","gravatar_id":"","url":"https://api.github.com/users/Copilot","html_url":"https://github.com/apps/copilot-pull-request-reviewer","followers_url":"https://api.github.com/users/Copilot/followers","following_url":"https://api.github.com/users/Copilot/following{/other_user}","gists_url":"https://api.github.com/users/Copilot/gists{/gist_id}","starred_url":"https://api.github.com/users/Copilot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Copilot/subscriptions","organizations_url":"https://api.github.com/users/Copilot/orgs","repos_url":"https://api.github.com/users/Copilot/repos","events_url":"https://api.github.com/users/Copilot/events{/privacy}","received_events_url":"https://api.github.com/users/Copilot/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"Some lines in this doc exceed the repoâ€™s markdownlint MD013 max line length (80), which will fail CI. Please wrap long bullet lines (e.g., this section) to <= 80 characters.","created_at":"2026-02-09T11:11:18Z","updated_at":"2026-02-09T11:11:21Z","html_url":"https://github.com/cwalinapj/DECENTRALIZED-DNS-/pull/51#discussion_r2782039250","pull_request_url":"https://api.github.com/repos/cwalinapj/DECENTRALIZED-DNS-/pulls/51","_links":{"self":{"href":"https://api.github.com/repos/cwalinapj/DECENTRALIZED-DNS-/pulls/comments/2782039250"},"html":{"href":"https://github.com/cwalinapj/DECENTRALIZED-DNS-/pull/51#discussion_r2782039250"},"pull_request":{"href":"https://api.github.com/repos/cwalinapj/DECENTRALIZED-DNS-/pulls/51"}},"reactions":{"url":"https://api.github.com/repos/cwalinapj/DECENTRALIZED-DNS-/pulls/comments/2782039250/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":17,"original_start_line":17,"start_side":"RIGHT","line":20,"original_line":20,"side":"RIGHT","author_association":"NONE","original_position":20,"position":20,"subject_type":"line"},{"url":"https://api.github.com/repos/cwalinapj/DECENTRALIZED-DNS-/pulls/comments/2782039269","pull_request_review_id":3772692433,"id":2782039269,"node_id":"PRRC_kwDORKbd9s6l0ozl","diff_hunk":"@@ -0,0 +1,49 @@\n+# miner-witness (MVP)\n+\n+This service is an **MVP bootstrap** component: it submits miner epoch stats to the on-chain `ddns_miner_score` program.\n+\n+It does **not** verify receipts on-chain. It assumes stats are computed off-chain (by miner/verifier logic) and submitted by an allowlisted submitter in `MinerScoreConfig`.\n+","path":"services/miner-witness/README.md","commit_id":"b4177e6c2f4f33c69b0d1b926a209755707e1728","original_commit_id":"b4177e6c2f4f33c69b0d1b926a209755707e1728","user":{"login":"Copilot","id":175728472,"node_id":"BOT_kgDOCnlnWA","avatar_url":"https://avatars.githubusercontent.com/in/946600?v=4","gravatar_id":"","url":"https://api.github.com/users/Copilot","html_url":"https://github.com/apps/copilot-pull-request-reviewer","followers_url":"https://api.github.com/users/Copilot/followers","following_url":"https://api.github.com/users/Copilot/following{/other_user}","gists_url":"https://api.github.com/users/Copilot/gists{/gist_id}","starred_url":"https://api.github.com/users/Copilot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Copilot/subscriptions","organizations_url":"https://api.github.com/users/Copilot/orgs","repos_url":"https://api.github.com/users/Copilot/repos","events_url":"https://api.github.com/users/Copilot/events{/privacy}","received_events_url":"https://api.github.com/users/Copilot/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"Several lines here are >80 chars (markdownlint MD013) and will fail the Docs formatting CI job. Wrap these long sentences across multiple lines.","created_at":"2026-02-09T11:11:18Z","updated_at":"2026-02-09T11:11:21Z","html_url":"https://github.com/cwalinapj/DECENTRALIZED-DNS-/pull/51#discussion_r2782039269","pull_request_url":"https://api.github.com/repos/cwalinapj/DECENTRALIZED-DNS-/pulls/51","_links":{"self":{"href":"https://api.github.com/repos/cwalinapj/DECENTRALIZED-DNS-/pulls/comments/2782039269"},"html":{"href":"https://github.com/cwalinapj/DECENTRALIZED-DNS-/pull/51#discussion_r2782039269"},"pull_request":{"href":"https://api.github.com/repos/cwalinapj/DECENTRALIZED-DNS-/pulls/51"}},"reactions":{"url":"https://api.github.com/repos/cwalinapj/DECENTRALIZED-DNS-/pulls/comments/2782039269/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":3,"original_start_line":3,"start_side":"RIGHT","line":6,"original_line":6,"side":"RIGHT","author_association":"NONE","original_position":6,"position":6,"subject_type":"line"},{"url":"https://api.github.com/repos/cwalinapj/DECENTRALIZED-DNS-/pulls/comments/2782039293","pull_request_review_id":3772692433,"id":2782039293,"node_id":"PRRC_kwDORKbd9s6l0oz9","diff_hunk":"@@ -0,0 +1,347 @@\n+import fs from \"node:fs\";\n+import path from \"node:path\";\n+import crypto from \"node:crypto\";\n+import yargs from \"yargs\";\n+import { hideBin } from \"yargs/helpers\";\n+import * as anchor from \"@coral-xyz/anchor\";\n+import { Connection, Keypair, PublicKey, SystemProgram } from \"@solana/web3.js\";\n+import BN from \"bn.js\";\n+import {\n+  TOKEN_PROGRAM_ID,\n+  createMint,\n+  getOrCreateAssociatedTokenAccount,\n+  mintTo,\n+} from \"@solana/spl-token\";\n+\n+function loadKeypair(filePath: string): Keypair {\n+  const raw = JSON.parse(fs.readFileSync(filePath, \"utf8\"));\n+  return Keypair.fromSecretKey(Uint8Array.from(raw));\n+}\n+\n+function loadIdl() {\n+  const idlPath = path.resolve(\"target/idl/ddns_miner_score.json\");\n+  if (!fs.existsSync(idlPath)) {\n+    throw new Error(`IDL not found at ${idlPath}. Run 'anchor build' in /solana first.`);\n+  }\n+  return JSON.parse(fs.readFileSync(idlPath, \"utf8\"));\n+}\n+\n+function readProgramIdFromAnchorToml(rpcUrl: string): string | null {\n+  try {\n+    const tomlPath = path.resolve(\"Anchor.toml\");\n+    if (!fs.existsSync(tomlPath)) return null;\n+    const content = fs.readFileSync(tomlPath, \"utf8\");\n+    const isLocal = /127\\\\.0\\\\.0\\\\.1|localhost/.test(rpcUrl);\n+    const section = isLocal ? \"programs.localnet\" : \"programs.devnet\";\n+    const re = new RegExp(\n+      `\\\\[${section}\\\\][^\\\\[]*?ddns_miner_score\\\\s*=\\\\s*\\\"([^\\\"]+)\\\"`,\n+      \"s\"\n+    );\n+    const match = content.match(re);\n+    return match ? match[1] : null;\n+  } catch {\n+    return null;\n+  }\n+}\n+\n+function sha256(buf: Buffer): Buffer {\n+  return crypto.createHash(\"sha256\").update(buf).digest();\n+}\n+\n+function u64le(n: bigint): Buffer {\n+  const b = Buffer.alloc(8);\n+  b.writeBigUInt64LE(n);\n+  return b;\n+}\n+\n+async function main() {\n+  const argv = await yargs(hideBin(process.argv))\n+    .command(\"init-config\", \"Init miner score config + reward vault\", (y) =>\n+      y\n+        .option(\"epoch-len-slots\", { type: \"number\", default: 100 })\n+        .option(\"base-reward\", { type: \"string\", default: \"0\" })\n+        .option(\"cap\", { type: \"string\", default: \"0\" })\n+        .option(\"min-stake-weight\", { type: \"string\", default: \"0\" })\n+        .option(\"toll-mint\", { type: \"string\", describe: \"defaults to new mint (localnet convenience)\" })\n+        .option(\"submitters\", { type: \"string\", describe: \"comma-separated pubkeys (default wallet)\" })\n+        .option(\"miners\", { type: \"string\", describe: \"comma-separated pubkeys (default wallet)\" })\n+        .option(\"diversity-target\", { type: \"number\", default: 100 })\n+        .option(\"alpha-correctness\", { type: \"number\", default: 5000 })\n+        .option(\"alpha-diversity\", { type: \"number\", default: 2000 })\n+        .option(\"alpha-timeliness\", { type: \"number\", default: 2000 })\n+        .option(\"alpha-uptime\", { type: \"number\", default: 1000 })\n+        .option(\"penalty-bps\", { type: \"number\", default: 2000 })\n+        .option(\"dominance-threshold-bps\", { type: \"number\", default: 2500 })\n+    )\n+    .command(\"report\", \"Report miner epoch stats\", (y) =>\n+      y\n+        .option(\"epoch\", { type: \"number\", demandOption: true })\n+        .option(\"miner\", { type: \"string\", demandOption: true })\n+        .option(\"stake-weight\", { type: \"string\", demandOption: true })\n+        .option(\"aggregates\", { type: \"number\", demandOption: true })\n+        .option(\"unique-names\", { type: \"number\", demandOption: true })\n+        .option(\"unique-receipts\", { type: \"number\", demandOption: true })\n+        .option(\"first-slot\", { type: \"number\", demandOption: true })\n+        .option(\"last-slot\", { type: \"number\", demandOption: true })\n+        .option(\"uptime\", { type: \"number\", default: 10000 })\n+        .option(\"correctness\", { type: \"number\", default: 10000 })\n+        .option(\"dominance\", { type: \"number\", default: 0 })\n+    )\n+    .command(\"finalize-epoch\", \"Finalize epoch totals (O(1))\", (y) =>\n+      y\n+        .option(\"epoch\", { type: \"number\", demandOption: true })\n+        .option(\"total-raw\", { type: \"string\", demandOption: true, describe: \"u128 decimal\" })\n+        .option(\"total-normalized\", { type: \"string\", demandOption: true, describe: \"u128 decimal\" })\n+        .option(\"pool\", { type: \"string\", demandOption: true, describe: \"u64 planned rewards (base units)\" })\n+        .option(\"miner-count\", { type: \"number\", demandOption: true })\n+        .option(\"dominance-max\", { type: \"number\", demandOption: true })\n+    )\n+    .command(\"set-reward\", \"Set a miner reward for an epoch\", (y) =>\n+      y\n+        .option(\"epoch\", { type: \"number\", demandOption: true })\n+        .option(\"miner\", { type: \"string\", demandOption: true })\n+        .option(\"normalized\", { type: \"string\", demandOption: true, describe: \"u128 decimal\" })\n+        .option(\"amount\", { type: \"string\", demandOption: true })\n+    )\n+    .command(\"claim\", \"Claim reward for wallet miner\", (y) =>\n+      y.option(\"epoch\", { type: \"number\", demandOption: true })\n+    )\n+    .command(\"penalize\", \"Apply a penalty (reduces reward if not claimed)\", (y) =>\n+      y\n+        .option(\"epoch\", { type: \"number\", demandOption: true })\n+        .option(\"miner\", { type: \"string\", demandOption: true })\n+        .option(\"penalty-bps\", { type: \"number\", demandOption: true })\n+        .option(\"reason\", { type: \"string\", demandOption: true })\n+    )\n+    .option(\"rpc\", { type: \"string\" })\n+    .option(\"wallet\", { type: \"string\" })\n+    .option(\"program-id\", { type: \"string\" })\n+    .demandCommand(1)\n+    .strict()\n+    .parse();\n+\n+  if (argv.rpc) process.env.ANCHOR_PROVIDER_URL = argv.rpc;\n+  if (argv.wallet) process.env.ANCHOR_WALLET = argv.wallet;\n+\n+  const rpcUrl = process.env.ANCHOR_PROVIDER_URL || \"https://api.devnet.solana.com\";\n+  const walletPath =\n+    process.env.ANCHOR_WALLET || path.join(process.env.HOME || \".\", \".config/solana/id.json\");\n+\n+  const payer = loadKeypair(walletPath);\n+  const connection = new Connection(rpcUrl, \"confirmed\");\n+  const provider = new anchor.AnchorProvider(connection, new anchor.Wallet(payer), {\n+    commitment: \"confirmed\",\n+  });\n+  anchor.setProvider(provider);\n+\n+  const idl = loadIdl();\n+  const programIdStr =\n+    (argv[\"program-id\"] as string | undefined) ||\n+    process.env.DDNS_MINER_SCORE_PROGRAM_ID ||\n+    readProgramIdFromAnchorToml(rpcUrl);\n+  if (!programIdStr) throw new Error(\"program id not found (set --program-id or DDNS_MINER_SCORE_PROGRAM_ID)\");\n+  const programId = new PublicKey(programIdStr);\n+  const program = new anchor.Program(idl as any, programId, provider);\n+\n+  const [configPda] = PublicKey.findProgramAddressSync([Buffer.from(\"miner_score_config\")], programId);\n+  const [vaultAuthority] = PublicKey.findProgramAddressSync([Buffer.from(\"miner_score_vault_authority\")], programId);\n+  const [rewardVaultPda] = PublicKey.findProgramAddressSync([Buffer.from(\"reward_vault\")], programId);\n+\n+  const cmd = argv._[0];\n+\n+  if (cmd === \"init-config\") {\n+    let tollMint = argv[\"toll-mint\"] ? new PublicKey(argv[\"toll-mint\"] as string) : null;\n+    if (!tollMint) {\n+      tollMint = await createMint(connection, payer, payer.publicKey, null, 9);\n+      const ata = await getOrCreateAssociatedTokenAccount(connection, payer, tollMint, payer.publicKey);\n+      await mintTo(connection, payer, tollMint, ata.address, payer, 1_000_000_000_000n);\n+      console.log(\"created toll_mint:\", tollMint.toBase58());\n+    }\n+\n+    const submitters =\n+      (argv.submitters as string | undefined)?.split(\",\").filter(Boolean).map((s) => new PublicKey(s)) ||\n+      [payer.publicKey];\n+    const miners =\n+      (argv.miners as string | undefined)?.split(\",\").filter(Boolean).map((s) => new PublicKey(s)) ||\n+      [payer.publicKey];\n+\n+    const sig = await program.methods\n+      .initMinerScoreConfig(\n+        new BN(argv[\"epoch-len-slots\"] as number),\n+        new BN(argv[\"base-reward\"] as string),\n+        new BN(argv.cap as string),\n+        new BN(argv[\"min-stake-weight\"] as string),\n+        submitters,\n+        miners,\n+        argv[\"alpha-correctness\"] as number,\n+        argv[\"alpha-diversity\"] as number,\n+        argv[\"alpha-timeliness\"] as number,\n+        argv[\"alpha-uptime\"] as number,\n+        argv[\"penalty-bps\"] as number,\n+        argv[\"dominance-threshold-bps\"] as number,\n+        argv[\"diversity-target\"] as number\n+      )\n+      .accounts({\n+        config: configPda,\n+        vaultAuthority,\n+        tollMint,\n+        rewardVault: rewardVaultPda,\n+        authority: payer.publicKey,\n+        tokenProgram: TOKEN_PROGRAM_ID,\n+        systemProgram: SystemProgram.programId,\n+        rent: anchor.web3.SYSVAR_RENT_PUBKEY,\n+      })\n+      .rpc();\n+\n+    console.log(JSON.stringify({ tx: sig, programId: programId.toBase58(), configPda: configPda.toBase58(), vaultAuthority: vaultAuthority.toBase58(), tollMint: tollMint.toBase58() }, null, 2));\n+    return;\n+  }\n+\n+  if (cmd === \"report\") {\n+    const epochId = BigInt(argv.epoch);\n+    const miner = new PublicKey(argv.miner as string);\n+    const [minerEpochPda] = PublicKey.findProgramAddressSync(\n+      [Buffer.from(\"miner_epoch\"), u64le(epochId), miner.toBuffer()],\n+      programId\n+    );\n+\n+    const sig = await program.methods\n+      .reportMinerEpochStats(\n+        new BN(argv.epoch),\n+        miner,\n+        new BN(argv[\"stake-weight\"] as string),\n+        argv.aggregates as number,\n+        argv[\"unique-names\"] as number,\n+        argv[\"unique-receipts\"] as number,\n+        new BN(argv[\"first-slot\"] as number),\n+        new BN(argv[\"last-slot\"] as number),\n+        argv.uptime as number,\n+        argv.correctness as number,\n+        argv.dominance as number\n+      )\n+      .accounts({\n+        config: configPda,\n+        minerEpoch: minerEpochPda,\n+        submitter: payer.publicKey,\n+        systemProgram: SystemProgram.programId,\n+      })\n+      .rpc();\n+\n+    console.log(JSON.stringify({ tx: sig, minerEpochPda: minerEpochPda.toBase58() }, null, 2));\n+    return;\n+  }\n+\n+  if (cmd === \"finalize-epoch\") {\n+    const epochId = BigInt(argv.epoch);\n+    const [epochTotalsPda] = PublicKey.findProgramAddressSync(\n+      [Buffer.from(\"epoch_totals\"), u64le(epochId)],\n+      programId\n+    );\n+\n+    const sig = await program.methods\n+      .finalizeEpoch(\n+        new BN(argv.epoch),\n+        new BN(argv[\"total-raw\"] as string),\n+        new BN(argv[\"total-normalized\"] as string),\n+        new BN(argv.pool as string),\n+        argv[\"miner-count\"] as number,\n+        argv[\"dominance-max\"] as number\n+      )\n+      .accounts({\n+        config: configPda,\n+        epochTotals: epochTotalsPda,\n+        submitter: payer.publicKey,\n+        systemProgram: SystemProgram.programId,\n+      })\n+      .rpc();\n+    console.log(JSON.stringify({ tx: sig, epochTotalsPda: epochTotalsPda.toBase58() }, null, 2));\n+    return;\n+  }\n+\n+  if (cmd === \"set-reward\") {\n+    const epochId = BigInt(argv.epoch);\n+    const miner = new PublicKey(argv.miner as string);\n+    const [epochTotalsPda] = PublicKey.findProgramAddressSync(\n+      [Buffer.from(\"epoch_totals\"), u64le(epochId)],\n+      programId\n+    );\n+    const [minerEpochPda] = PublicKey.findProgramAddressSync(\n+      [Buffer.from(\"miner_epoch\"), u64le(epochId), miner.toBuffer()],\n+      programId\n+    );\n+    const sig = await program.methods\n+      .setMinerReward(new BN(argv.epoch), miner, new BN(argv.normalized as string), new BN(argv.amount as string))\n+      .accounts({\n+        config: configPda,\n+        epochTotals: epochTotalsPda,\n+        minerEpoch: minerEpochPda,\n+        submitter: payer.publicKey,\n+      })\n+      .rpc();\n+    console.log(JSON.stringify({ tx: sig, minerEpochPda: minerEpochPda.toBase58() }, null, 2));\n+    return;\n+  }\n+\n+  if (cmd === \"claim\") {\n+    const epochId = BigInt(argv.epoch);\n+    const [epochTotalsPda] = PublicKey.findProgramAddressSync(\n+      [Buffer.from(\"epoch_totals\"), u64le(epochId)],\n+      programId\n+    );\n+    const [minerEpochPda] = PublicKey.findProgramAddressSync(\n+      [Buffer.from(\"miner_epoch\"), u64le(epochId), payer.publicKey.toBuffer()],\n+      programId\n+    );\n+    const [claimPda] = PublicKey.findProgramAddressSync(\n+      [Buffer.from(\"claim\"), u64le(epochId), payer.publicKey.toBuffer()],\n+      programId\n+    );\n+    const cfg: any = await program.account.minerScoreConfig.fetch(configPda);\n+    const tollMint = new PublicKey(cfg.tollMint);\n+    const minerAta = getAssociatedTokenAddressSync(tollMint, payer.publicKey);\n+","path":"solana/scripts/miner_score.ts","commit_id":"b4177e6c2f4f33c69b0d1b926a209755707e1728","original_commit_id":"b4177e6c2f4f33c69b0d1b926a209755707e1728","user":{"login":"Copilot","id":175728472,"node_id":"BOT_kgDOCnlnWA","avatar_url":"https://avatars.githubusercontent.com/in/946600?v=4","gravatar_id":"","url":"https://api.github.com/users/Copilot","html_url":"https://github.com/apps/copilot-pull-request-reviewer","followers_url":"https://api.github.com/users/Copilot/followers","following_url":"https://api.github.com/users/Copilot/following{/other_user}","gists_url":"https://api.github.com/users/Copilot/gists{/gist_id}","starred_url":"https://api.github.com/users/Copilot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Copilot/subscriptions","organizations_url":"https://api.github.com/users/Copilot/orgs","repos_url":"https://api.github.com/users/Copilot/repos","events_url":"https://api.github.com/users/Copilot/events{/privacy}","received_events_url":"https://api.github.com/users/Copilot/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"`getAssociatedTokenAddressSync` is used to derive `minerAta` but it is not imported, and the repo otherwise uses the async `getAssociatedTokenAddress` helper (see `mint_toll_pass.ts`). As written, this will throw at runtime (or fail typecheck) when running the script. Import the correct helper (and `await` it if using the async variant) so `minerAta` is derived correctly.","created_at":"2026-02-09T11:11:19Z","updated_at":"2026-02-09T11:11:21Z","html_url":"https://github.com/cwalinapj/DECENTRALIZED-DNS-/pull/51#discussion_r2782039293","pull_request_url":"https://api.github.com/repos/cwalinapj/DECENTRALIZED-DNS-/pulls/51","_links":{"self":{"href":"https://api.github.com/repos/cwalinapj/DECENTRALIZED-DNS-/pulls/comments/2782039293"},"html":{"href":"https://github.com/cwalinapj/DECENTRALIZED-DNS-/pull/51#discussion_r2782039293"},"pull_request":{"href":"https://api.github.com/repos/cwalinapj/DECENTRALIZED-DNS-/pulls/51"}},"reactions":{"url":"https://api.github.com/repos/cwalinapj/DECENTRALIZED-DNS-/pulls/comments/2782039293/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":299,"original_start_line":299,"start_side":"RIGHT","line":302,"original_line":302,"side":"RIGHT","author_association":"NONE","original_position":302,"position":302,"subject_type":"line"},{"url":"https://api.github.com/repos/cwalinapj/DECENTRALIZED-DNS-/pulls/comments/2782039310","pull_request_review_id":3772692433,"id":2782039310,"node_id":"PRRC_kwDORKbd9s6l0o0O","diff_hunk":"@@ -0,0 +1,347 @@\n+import fs from \"node:fs\";\n+import path from \"node:path\";\n+import crypto from \"node:crypto\";\n+import yargs from \"yargs\";\n+import { hideBin } from \"yargs/helpers\";\n+import * as anchor from \"@coral-xyz/anchor\";\n+import { Connection, Keypair, PublicKey, SystemProgram } from \"@solana/web3.js\";\n+import BN from \"bn.js\";\n+import {\n+  TOKEN_PROGRAM_ID,\n+  createMint,\n+  getOrCreateAssociatedTokenAccount,\n+  mintTo,\n+} from \"@solana/spl-token\";\n+\n+function loadKeypair(filePath: string): Keypair {\n+  const raw = JSON.parse(fs.readFileSync(filePath, \"utf8\"));\n+  return Keypair.fromSecretKey(Uint8Array.from(raw));\n+}\n+\n+function loadIdl() {\n+  const idlPath = path.resolve(\"target/idl/ddns_miner_score.json\");\n+  if (!fs.existsSync(idlPath)) {\n+    throw new Error(`IDL not found at ${idlPath}. Run 'anchor build' in /solana first.`);\n+  }\n+  return JSON.parse(fs.readFileSync(idlPath, \"utf8\"));\n+}\n+\n+function readProgramIdFromAnchorToml(rpcUrl: string): string | null {\n+  try {\n+    const tomlPath = path.resolve(\"Anchor.toml\");\n+    if (!fs.existsSync(tomlPath)) return null;\n+    const content = fs.readFileSync(tomlPath, \"utf8\");\n+    const isLocal = /127\\\\.0\\\\.0\\\\.1|localhost/.test(rpcUrl);\n+    const section = isLocal ? \"programs.localnet\" : \"programs.devnet\";\n+    const re = new RegExp(\n+      `\\\\[${section}\\\\][^\\\\[]*?ddns_miner_score\\\\s*=\\\\s*\\\"([^\\\"]+)\\\"`,\n+      \"s\"\n+    );\n+    const match = content.match(re);\n+    return match ? match[1] : null;\n+  } catch {\n+    return null;\n+  }\n+}\n+\n+function sha256(buf: Buffer): Buffer {\n+  return crypto.createHash(\"sha256\").update(buf).digest();\n+}\n+\n+function u64le(n: bigint): Buffer {\n+  const b = Buffer.alloc(8);\n+  b.writeBigUInt64LE(n);\n+  return b;\n+}\n+\n+async function main() {\n+  const argv = await yargs(hideBin(process.argv))\n+    .command(\"init-config\", \"Init miner score config + reward vault\", (y) =>\n+      y\n+        .option(\"epoch-len-slots\", { type: \"number\", default: 100 })\n+        .option(\"base-reward\", { type: \"string\", default: \"0\" })\n+        .option(\"cap\", { type: \"string\", default: \"0\" })\n+        .option(\"min-stake-weight\", { type: \"string\", default: \"0\" })\n+        .option(\"toll-mint\", { type: \"string\", describe: \"defaults to new mint (localnet convenience)\" })\n+        .option(\"submitters\", { type: \"string\", describe: \"comma-separated pubkeys (default wallet)\" })\n+        .option(\"miners\", { type: \"string\", describe: \"comma-separated pubkeys (default wallet)\" })\n+        .option(\"diversity-target\", { type: \"number\", default: 100 })\n+        .option(\"alpha-correctness\", { type: \"number\", default: 5000 })\n+        .option(\"alpha-diversity\", { type: \"number\", default: 2000 })\n+        .option(\"alpha-timeliness\", { type: \"number\", default: 2000 })\n+        .option(\"alpha-uptime\", { type: \"number\", default: 1000 })\n+        .option(\"penalty-bps\", { type: \"number\", default: 2000 })\n+        .option(\"dominance-threshold-bps\", { type: \"number\", default: 2500 })\n+    )\n+    .command(\"report\", \"Report miner epoch stats\", (y) =>\n+      y\n+        .option(\"epoch\", { type: \"number\", demandOption: true })\n+        .option(\"miner\", { type: \"string\", demandOption: true })\n+        .option(\"stake-weight\", { type: \"string\", demandOption: true })\n+        .option(\"aggregates\", { type: \"number\", demandOption: true })\n+        .option(\"unique-names\", { type: \"number\", demandOption: true })\n+        .option(\"unique-receipts\", { type: \"number\", demandOption: true })\n+        .option(\"first-slot\", { type: \"number\", demandOption: true })\n+        .option(\"last-slot\", { type: \"number\", demandOption: true })\n+        .option(\"uptime\", { type: \"number\", default: 10000 })","path":"solana/scripts/miner_score.ts","commit_id":"b4177e6c2f4f33c69b0d1b926a209755707e1728","original_commit_id":"b4177e6c2f4f33c69b0d1b926a209755707e1728","user":{"login":"Copilot","id":175728472,"node_id":"BOT_kgDOCnlnWA","avatar_url":"https://avatars.githubusercontent.com/in/946600?v=4","gravatar_id":"","url":"https://api.github.com/users/Copilot","html_url":"https://github.com/apps/copilot-pull-request-reviewer","followers_url":"https://api.github.com/users/Copilot/followers","following_url":"https://api.github.com/users/Copilot/following{/other_user}","gists_url":"https://api.github.com/users/Copilot/gists{/gist_id}","starred_url":"https://api.github.com/users/Copilot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Copilot/subscriptions","organizations_url":"https://api.github.com/users/Copilot/orgs","repos_url":"https://api.github.com/users/Copilot/repos","events_url":"https://api.github.com/users/Copilot/events{/privacy}","received_events_url":"https://api.github.com/users/Copilot/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"The `report` command parses `epoch`, `first-slot`, and `last-slot` as JS `number`s, but these values are u64 on-chain and Solana slots can exceed `Number.MAX_SAFE_INTEGER`. This can silently corrupt the values before they reach `BN`/PDA derivation. Use string inputs (or BigInt parsing from string) for all u64-like CLI params.","created_at":"2026-02-09T11:11:19Z","updated_at":"2026-02-09T11:11:21Z","html_url":"https://github.com/cwalinapj/DECENTRALIZED-DNS-/pull/51#discussion_r2782039310","pull_request_url":"https://api.github.com/repos/cwalinapj/DECENTRALIZED-DNS-/pulls/51","_links":{"self":{"href":"https://api.github.com/repos/cwalinapj/DECENTRALIZED-DNS-/pulls/comments/2782039310"},"html":{"href":"https://github.com/cwalinapj/DECENTRALIZED-DNS-/pull/51#discussion_r2782039310"},"pull_request":{"href":"https://api.github.com/repos/cwalinapj/DECENTRALIZED-DNS-/pulls/51"}},"reactions":{"url":"https://api.github.com/repos/cwalinapj/DECENTRALIZED-DNS-/pulls/comments/2782039310/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":78,"original_start_line":78,"start_side":"RIGHT","line":86,"original_line":86,"side":"RIGHT","author_association":"NONE","original_position":86,"position":86,"subject_type":"line"},{"url":"https://api.github.com/repos/cwalinapj/DECENTRALIZED-DNS-/pulls/comments/2782039340","pull_request_review_id":3772692433,"id":2782039340,"node_id":"PRRC_kwDORKbd9s6l0o0s","diff_hunk":"@@ -0,0 +1,347 @@\n+import fs from \"node:fs\";\n+import path from \"node:path\";\n+import crypto from \"node:crypto\";\n+import yargs from \"yargs\";\n+import { hideBin } from \"yargs/helpers\";\n+import * as anchor from \"@coral-xyz/anchor\";\n+import { Connection, Keypair, PublicKey, SystemProgram } from \"@solana/web3.js\";\n+import BN from \"bn.js\";\n+import {\n+  TOKEN_PROGRAM_ID,\n+  createMint,\n+  getOrCreateAssociatedTokenAccount,\n+  mintTo,\n+} from \"@solana/spl-token\";\n+\n+function loadKeypair(filePath: string): Keypair {\n+  const raw = JSON.parse(fs.readFileSync(filePath, \"utf8\"));\n+  return Keypair.fromSecretKey(Uint8Array.from(raw));\n+}\n+\n+function loadIdl() {\n+  const idlPath = path.resolve(\"target/idl/ddns_miner_score.json\");\n+  if (!fs.existsSync(idlPath)) {\n+    throw new Error(`IDL not found at ${idlPath}. Run 'anchor build' in /solana first.`);\n+  }\n+  return JSON.parse(fs.readFileSync(idlPath, \"utf8\"));\n+}\n+\n+function readProgramIdFromAnchorToml(rpcUrl: string): string | null {\n+  try {\n+    const tomlPath = path.resolve(\"Anchor.toml\");\n+    if (!fs.existsSync(tomlPath)) return null;\n+    const content = fs.readFileSync(tomlPath, \"utf8\");\n+    const isLocal = /127\\\\.0\\\\.0\\\\.1|localhost/.test(rpcUrl);\n+    const section = isLocal ? \"programs.localnet\" : \"programs.devnet\";\n+    const re = new RegExp(\n+      `\\\\[${section}\\\\][^\\\\[]*?ddns_miner_score\\\\s*=\\\\s*\\\"([^\\\"]+)\\\"`,\n+      \"s\"\n+    );\n+    const match = content.match(re);\n+    return match ? match[1] : null;\n+  } catch {\n+    return null;\n+  }\n+}\n+\n+function sha256(buf: Buffer): Buffer {\n+  return crypto.createHash(\"sha256\").update(buf).digest();\n+}\n+\n+function u64le(n: bigint): Buffer {\n+  const b = Buffer.alloc(8);\n+  b.writeBigUInt64LE(n);\n+  return b;\n+}\n+\n+async function main() {\n+  const argv = await yargs(hideBin(process.argv))\n+    .command(\"init-config\", \"Init miner score config + reward vault\", (y) =>\n+      y\n+        .option(\"epoch-len-slots\", { type: \"number\", default: 100 })\n+        .option(\"base-reward\", { type: \"string\", default: \"0\" })\n+        .option(\"cap\", { type: \"string\", default: \"0\" })\n+        .option(\"min-stake-weight\", { type: \"string\", default: \"0\" })\n+        .option(\"toll-mint\", { type: \"string\", describe: \"defaults to new mint (localnet convenience)\" })\n+        .option(\"submitters\", { type: \"string\", describe: \"comma-separated pubkeys (default wallet)\" })\n+        .option(\"miners\", { type: \"string\", describe: \"comma-separated pubkeys (default wallet)\" })\n+        .option(\"diversity-target\", { type: \"number\", default: 100 })\n+        .option(\"alpha-correctness\", { type: \"number\", default: 5000 })\n+        .option(\"alpha-diversity\", { type: \"number\", default: 2000 })\n+        .option(\"alpha-timeliness\", { type: \"number\", default: 2000 })\n+        .option(\"alpha-uptime\", { type: \"number\", default: 1000 })\n+        .option(\"penalty-bps\", { type: \"number\", default: 2000 })\n+        .option(\"dominance-threshold-bps\", { type: \"number\", default: 2500 })\n+    )\n+    .command(\"report\", \"Report miner epoch stats\", (y) =>\n+      y\n+        .option(\"epoch\", { type: \"number\", demandOption: true })\n+        .option(\"miner\", { type: \"string\", demandOption: true })\n+        .option(\"stake-weight\", { type: \"string\", demandOption: true })\n+        .option(\"aggregates\", { type: \"number\", demandOption: true })\n+        .option(\"unique-names\", { type: \"number\", demandOption: true })\n+        .option(\"unique-receipts\", { type: \"number\", demandOption: true })\n+        .option(\"first-slot\", { type: \"number\", demandOption: true })\n+        .option(\"last-slot\", { type: \"number\", demandOption: true })\n+        .option(\"uptime\", { type: \"number\", default: 10000 })\n+        .option(\"correctness\", { type: \"number\", default: 10000 })\n+        .option(\"dominance\", { type: \"number\", default: 0 })\n+    )\n+    .command(\"finalize-epoch\", \"Finalize epoch totals (O(1))\", (y) =>\n+      y\n+        .option(\"epoch\", { type: \"number\", demandOption: true })\n+        .option(\"total-raw\", { type: \"string\", demandOption: true, describe: \"u128 decimal\" })\n+        .option(\"total-normalized\", { type: \"string\", demandOption: true, describe: \"u128 decimal\" })\n+        .option(\"pool\", { type: \"string\", demandOption: true, describe: \"u64 planned rewards (base units)\" })\n+        .option(\"miner-count\", { type: \"number\", demandOption: true })\n+        .option(\"dominance-max\", { type: \"number\", demandOption: true })\n+    )\n+    .command(\"set-reward\", \"Set a miner reward for an epoch\", (y) =>\n+      y\n+        .option(\"epoch\", { type: \"number\", demandOption: true })\n+        .option(\"miner\", { type: \"string\", demandOption: true })\n+        .option(\"normalized\", { type: \"string\", demandOption: true, describe: \"u128 decimal\" })\n+        .option(\"amount\", { type: \"string\", demandOption: true })\n+    )\n+    .command(\"claim\", \"Claim reward for wallet miner\", (y) =>\n+      y.option(\"epoch\", { type: \"number\", demandOption: true })\n+    )\n+    .command(\"penalize\", \"Apply a penalty (reduces reward if not claimed)\", (y) =>\n+      y\n+        .option(\"epoch\", { type: \"number\", demandOption: true })\n+        .option(\"miner\", { type: \"string\", demandOption: true })\n+        .option(\"penalty-bps\", { type: \"number\", demandOption: true })\n+        .option(\"reason\", { type: \"string\", demandOption: true })\n+    )\n+    .option(\"rpc\", { type: \"string\" })\n+    .option(\"wallet\", { type: \"string\" })\n+    .option(\"program-id\", { type: \"string\" })\n+    .demandCommand(1)\n+    .strict()\n+    .parse();\n+\n+  if (argv.rpc) process.env.ANCHOR_PROVIDER_URL = argv.rpc;\n+  if (argv.wallet) process.env.ANCHOR_WALLET = argv.wallet;\n+\n+  const rpcUrl = process.env.ANCHOR_PROVIDER_URL || \"https://api.devnet.solana.com\";\n+  const walletPath =\n+    process.env.ANCHOR_WALLET || path.join(process.env.HOME || \".\", \".config/solana/id.json\");\n+\n+  const payer = loadKeypair(walletPath);\n+  const connection = new Connection(rpcUrl, \"confirmed\");\n+  const provider = new anchor.AnchorProvider(connection, new anchor.Wallet(payer), {\n+    commitment: \"confirmed\",\n+  });\n+  anchor.setProvider(provider);\n+\n+  const idl = loadIdl();\n+  const programIdStr =\n+    (argv[\"program-id\"] as string | undefined) ||\n+    process.env.DDNS_MINER_SCORE_PROGRAM_ID ||\n+    readProgramIdFromAnchorToml(rpcUrl);\n+  if (!programIdStr) throw new Error(\"program id not found (set --program-id or DDNS_MINER_SCORE_PROGRAM_ID)\");\n+  const programId = new PublicKey(programIdStr);\n+  const program = new anchor.Program(idl as any, programId, provider);\n+\n+  const [configPda] = PublicKey.findProgramAddressSync([Buffer.from(\"miner_score_config\")], programId);\n+  const [vaultAuthority] = PublicKey.findProgramAddressSync([Buffer.from(\"miner_score_vault_authority\")], programId);\n+  const [rewardVaultPda] = PublicKey.findProgramAddressSync([Buffer.from(\"reward_vault\")], programId);\n+\n+  const cmd = argv._[0];\n+\n+  if (cmd === \"init-config\") {\n+    let tollMint = argv[\"toll-mint\"] ? new PublicKey(argv[\"toll-mint\"] as string) : null;\n+    if (!tollMint) {\n+      tollMint = await createMint(connection, payer, payer.publicKey, null, 9);\n+      const ata = await getOrCreateAssociatedTokenAccount(connection, payer, tollMint, payer.publicKey);\n+      await mintTo(connection, payer, tollMint, ata.address, payer, 1_000_000_000_000n);\n+      console.log(\"created toll_mint:\", tollMint.toBase58());\n+    }\n+\n+    const submitters =\n+      (argv.submitters as string | undefined)?.split(\",\").filter(Boolean).map((s) => new PublicKey(s)) ||\n+      [payer.publicKey];\n+    const miners =\n+      (argv.miners as string | undefined)?.split(\",\").filter(Boolean).map((s) => new PublicKey(s)) ||\n+      [payer.publicKey];\n+\n+    const sig = await program.methods\n+      .initMinerScoreConfig(\n+        new BN(argv[\"epoch-len-slots\"] as number),\n+        new BN(argv[\"base-reward\"] as string),\n+        new BN(argv.cap as string),\n+        new BN(argv[\"min-stake-weight\"] as string),\n+        submitters,\n+        miners,\n+        argv[\"alpha-correctness\"] as number,\n+        argv[\"alpha-diversity\"] as number,\n+        argv[\"alpha-timeliness\"] as number,\n+        argv[\"alpha-uptime\"] as number,\n+        argv[\"penalty-bps\"] as number,\n+        argv[\"dominance-threshold-bps\"] as number,\n+        argv[\"diversity-target\"] as number\n+      )\n+      .accounts({\n+        config: configPda,\n+        vaultAuthority,\n+        tollMint,\n+        rewardVault: rewardVaultPda,\n+        authority: payer.publicKey,\n+        tokenProgram: TOKEN_PROGRAM_ID,\n+        systemProgram: SystemProgram.programId,\n+        rent: anchor.web3.SYSVAR_RENT_PUBKEY,\n+      })\n+      .rpc();\n+\n+    console.log(JSON.stringify({ tx: sig, programId: programId.toBase58(), configPda: configPda.toBase58(), vaultAuthority: vaultAuthority.toBase58(), tollMint: tollMint.toBase58() }, null, 2));\n+    return;\n+  }\n+\n+  if (cmd === \"report\") {\n+    const epochId = BigInt(argv.epoch);\n+    const miner = new PublicKey(argv.miner as string);\n+    const [minerEpochPda] = PublicKey.findProgramAddressSync(\n+      [Buffer.from(\"miner_epoch\"), u64le(epochId), miner.toBuffer()],\n+      programId\n+    );\n+\n+    const sig = await program.methods\n+      .reportMinerEpochStats(\n+        new BN(argv.epoch),\n+        miner,\n+        new BN(argv[\"stake-weight\"] as string),\n+        argv.aggregates as number,\n+        argv[\"unique-names\"] as number,\n+        argv[\"unique-receipts\"] as number,\n+        new BN(argv[\"first-slot\"] as number),\n+        new BN(argv[\"last-slot\"] as number),\n+        argv.uptime as number,\n+        argv.correctness as number,\n+        argv.dominance as number\n+      )\n+      .accounts({\n+        config: configPda,\n+        minerEpoch: minerEpochPda,\n+        submitter: payer.publicKey,\n+        systemProgram: SystemProgram.programId,\n+      })\n+      .rpc();\n+\n+    console.log(JSON.stringify({ tx: sig, minerEpochPda: minerEpochPda.toBase58() }, null, 2));\n+    return;\n+  }\n+\n+  if (cmd === \"finalize-epoch\") {\n+    const epochId = BigInt(argv.epoch);\n+    const [epochTotalsPda] = PublicKey.findProgramAddressSync(\n+      [Buffer.from(\"epoch_totals\"), u64le(epochId)],\n+      programId\n+    );\n+\n+    const sig = await program.methods\n+      .finalizeEpoch(\n+        new BN(argv.epoch),\n+        new BN(argv[\"total-raw\"] as string),\n+        new BN(argv[\"total-normalized\"] as string),\n+        new BN(argv.pool as string),\n+        argv[\"miner-count\"] as number,\n+        argv[\"dominance-max\"] as number\n+      )\n+      .accounts({\n+        config: configPda,\n+        epochTotals: epochTotalsPda,\n+        submitter: payer.publicKey,\n+        systemProgram: SystemProgram.programId,\n+      })\n+      .rpc();\n+    console.log(JSON.stringify({ tx: sig, epochTotalsPda: epochTotalsPda.toBase58() }, null, 2));\n+    return;\n+  }\n+\n+  if (cmd === \"set-reward\") {\n+    const epochId = BigInt(argv.epoch);\n+    const miner = new PublicKey(argv.miner as string);\n+    const [epochTotalsPda] = PublicKey.findProgramAddressSync(\n+      [Buffer.from(\"epoch_totals\"), u64le(epochId)],\n+      programId\n+    );\n+    const [minerEpochPda] = PublicKey.findProgramAddressSync(\n+      [Buffer.from(\"miner_epoch\"), u64le(epochId), miner.toBuffer()],\n+      programId\n+    );\n+    const sig = await program.methods\n+      .setMinerReward(new BN(argv.epoch), miner, new BN(argv.normalized as string), new BN(argv.amount as string))\n+      .accounts({\n+        config: configPda,\n+        epochTotals: epochTotalsPda,\n+        minerEpoch: minerEpochPda,\n+        submitter: payer.publicKey,\n+      })\n+      .rpc();\n+    console.log(JSON.stringify({ tx: sig, minerEpochPda: minerEpochPda.toBase58() }, null, 2));\n+    return;\n+  }\n+\n+  if (cmd === \"claim\") {\n+    const epochId = BigInt(argv.epoch);\n+    const [epochTotalsPda] = PublicKey.findProgramAddressSync(\n+      [Buffer.from(\"epoch_totals\"), u64le(epochId)],\n+      programId\n+    );","path":"solana/scripts/miner_score.ts","commit_id":"b4177e6c2f4f33c69b0d1b926a209755707e1728","original_commit_id":"b4177e6c2f4f33c69b0d1b926a209755707e1728","user":{"login":"Copilot","id":175728472,"node_id":"BOT_kgDOCnlnWA","avatar_url":"https://avatars.githubusercontent.com/in/946600?v=4","gravatar_id":"","url":"https://api.github.com/users/Copilot","html_url":"https://github.com/apps/copilot-pull-request-reviewer","followers_url":"https://api.github.com/users/Copilot/followers","following_url":"https://api.github.com/users/Copilot/following{/other_user}","gists_url":"https://api.github.com/users/Copilot/gists{/gist_id}","starred_url":"https://api.github.com/users/Copilot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Copilot/subscriptions","organizations_url":"https://api.github.com/users/Copilot/orgs","repos_url":"https://api.github.com/users/Copilot/repos","events_url":"https://api.github.com/users/Copilot/events{/privacy}","received_events_url":"https://api.github.com/users/Copilot/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"Unused variable epochTotalsPda.\n```suggestion\n\n```","created_at":"2026-02-09T11:11:19Z","updated_at":"2026-02-09T11:11:19Z","html_url":"https://github.com/cwalinapj/DECENTRALIZED-DNS-/pull/51#discussion_r2782039340","pull_request_url":"https://api.github.com/repos/cwalinapj/DECENTRALIZED-DNS-/pulls/51","_links":{"self":{"href":"https://api.github.com/repos/cwalinapj/DECENTRALIZED-DNS-/pulls/comments/2782039340"},"html":{"href":"https://github.com/cwalinapj/DECENTRALIZED-DNS-/pull/51#discussion_r2782039340"},"pull_request":{"href":"https://api.github.com/repos/cwalinapj/DECENTRALIZED-DNS-/pulls/51"}},"reactions":{"url":"https://api.github.com/repos/cwalinapj/DECENTRALIZED-DNS-/pulls/comments/2782039340/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":287,"original_start_line":287,"start_side":"RIGHT","line":290,"original_line":290,"side":"RIGHT","author_association":"NONE","original_position":290,"position":290,"subject_type":"line"}]